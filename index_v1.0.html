<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-01-01">

<title>Do protein language models understand evolution? Mixed evidence from ancestral sequences and ESM2 –</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./assets/logo_white.png" rel="icon" type="image/png">
<script src="site_libs/cookie-consent/cookie-consent.js"></script>
<link href="site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-2e258beaaab509f8ad3e40bd486fc5fc.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-08905YE5NE"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-08905YE5NE', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<!-- logo-animation.html -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const brandLink = document.querySelector(".navbar-brand");
    const logoImg = brandLink.querySelector("img.navbar-logo");
    const video = document.createElement("video");
    video.classList.add("navbar-logo", "video-logo");
    video.autoplay = true;
    video.muted = true;
    video.playsInline = true;
    video.loop = false;
    video.playbackRate = 1.0;

    const source = document.createElement("source");
    // Github Pages sites are served from a path like `https://arcadia-science.github.io/<repo>/`
    // so we need to add the repo name to the path when we're on Github Pages.
    const siteRoot = (window.location.hostname.endsWith('github.io')) ? `/${window.location.pathname.split('/')[1]}` : '';
    source.src = `${siteRoot}/assets/logo_movie.mp4`;
    source.type = "video/mp4";
    video.appendChild(source);

    // Function to handle video playback
    function handleVideoPlayback() {
      if (video.ended || video.paused) {
        video.currentTime = 0;
        video.playbackRate = 3.0;
        video.play().catch(e => console.log("Playback failed:", e));
      }
    }

    // Add hover event listener
    brandLink.addEventListener("mouseenter", handleVideoPlayback);

    // Handle visibility changes
    document.addEventListener("visibilitychange", function () {
      if (document.visibilityState === "visible") {
        handleVideoPlayback();
      }
    });

    // Handle page show (useful for mobile back button / screen unlock)
    window.addEventListener("pageshow", function (event) {
      if (event.persisted) {
        handleVideoPlayback();
      }
    });

    video.addEventListener("error", function () {
      console.error("Video playback error");
      logoImg.style.visibility = "visible";
      video.remove();
    });

    brandLink.appendChild(video);
  });
</script>
<template id="authors-template">
  <div class="authors-section">
    <button class="authors-toggle">
      <span class="authors-toggle-text">Show authors</span>
      <i class="bi bi-chevron-down authors-toggle-icon"></i>
    </button>
    <div class="authors-content quarto-title-meta-contents">
      <span class="author-order-indicator">(sorted A-Z)</span>
    </div>
  </div>
</template>

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
<script>
  initAuthorReveal();

  function initAuthorReveal() {
    require.config({
      paths: {
        'js-yaml': 'https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min'
      }
    });

    require(['js-yaml'], function (jsyaml) {
      // Function to get last name from full name
      function getLastName(fullName) {
        const nameParts = fullName.trim().split(' ');
        return nameParts[nameParts.length - 1];
      }

      // Function to load the YAML file
      async function loadAuthorData() {
        try {
          // Github Pages sites are served from a path like `https://arcadia-science.github.io/<repo>/`
          // so we need to add the repo name to the path when we're on Github Pages.
          const siteRoot = (window.location.hostname.endsWith('github.io')) ? `/${window.location.pathname.split('/')[1]}` : '';
          const authorYamlPath = `${siteRoot}/authors.yml`;
          const response = await fetch(authorYamlPath);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const yamlText = await response.text();
          window.authorData = jsyaml.load(yamlText);
          initializeAuthors();
        } catch (error) {
          console.error('Error loading author data:', error);
        }
      }

      function initializeAuthors() {
        // Find the quarto-title-meta div
        const titleMeta = document.querySelector('.quarto-title-meta');
        if (!titleMeta) {
          return;
        }

        // Get template content
        const template = document.getElementById('authors-template');
        if (!template) {
          return;
        }
        const authorsSection = template.content.cloneNode(true);

        // Get the authors content div from the cloned template
        const authorsContent = authorsSection.querySelector('.authors-content');

        // Update sort to use last name
        const sortedAuthors = [...authorData.authors].sort((a, b) => {
          const lastNameA = getLastName(a.name);
          const lastNameB = getLastName(b.name);
          return lastNameA.localeCompare(lastNameB);
        });

        // Process authors from the data
        sortedAuthors.forEach(author => {
          const authorP = document.createElement('p');

          // Create name span
          const nameSpan = document.createElement('span');
          nameSpan.className = 'author-name';
          nameSpan.textContent = author.name;
          authorP.appendChild(nameSpan);

          // Add ORCID if present
          if (author.orcid) {
            const orcidLink = document.createElement('a');
            orcidLink.href = `https://orcid.org/${author.orcid}`;
            orcidLink.className = 'quarto-title-author-orcid';

            const orcidImage = document.createElement('img');
            orcidImage.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==';
            orcidLink.appendChild(orcidImage);

            authorP.appendChild(orcidLink);
          }

          // Add to authors content
          authorsContent.appendChild(authorP);

          // Add tippy tooltip with roles if present
          if (author.roles) {
            const tooltipContent = `Roles: ${author.roles.map(r => r.charAt(0).toUpperCase() + r.slice(1)).join(', ')}`;
            tippy(nameSpan, {
              content: tooltipContent,
              allowHTML: true,
              placement: 'bottom',
              arrow: true,
              theme: 'custom'
            });
          }
        });

        // Create container and insert at the beginning of title meta
        const containerDiv = document.createElement('div');
        titleMeta.insertBefore(containerDiv, titleMeta.firstChild);
        containerDiv.appendChild(authorsSection);

        // Add toggle functionality
        const toggle = document.querySelector('.authors-toggle');
        const content = document.querySelector('.authors-content');

        if (!toggle || !content) {
          return;
        }

        toggle.addEventListener('click', () => {
          const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
          toggle.setAttribute('aria-expanded', !isExpanded);
          content.classList.toggle('is-visible');
        });

        // Initialize ARIA attributes
        toggle.setAttribute('aria-expanded', 'false');
        toggle.setAttribute('aria-controls', 'authors-content');
        content.setAttribute('id', 'authors-content');
      }

      // Start loading when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadAuthorData);
      } else {
        loadAuthorData();
      }
    });
  }
</script>
<template id="mini-title-template">
  <div class="mini-title page-columns page-full">
    <div class="mini-title-content">
      <div class="mini-title-logo-wrapper">
        <a href="https://research.arcadiascience.com/">
          <img class="logo-white" src="/assets/logo_white.png" alt="Logo">
        </a>
      </div>
      <p></p>
      <div id="mini-version-control"></div>
    </div>
  </div>
</template>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Get required elements
    const template = document.getElementById('mini-title-template');
    const titleBanner = document.querySelector('.quarto-title-banner');
    const abstract = document.querySelector('.abstract');
    const navbar = document.querySelector('#quarto-header');

    // Github Pages sites are served from a path like `https://arcadia-science.github.io/<repo>/`
    // so we need to add the repo name to the path when we're on Github Pages.
    const siteRoot = (window.location.hostname.endsWith('github.io')) ? `/${window.location.pathname.split('/')[1]}` : '';
    template.content.querySelector('.logo-white').src = `${siteRoot}/assets/logo_white.png`;

    let prevRatio = {appear: 1, disappear: 1};

    if (template && titleBanner && abstract && navbar) {
      // Add the mini title to the document body
      const miniTitleContent = document.importNode(template.content, true);
      document.body.appendChild(miniTitleContent);

      // Get and set the title text from h1.title
      const titleElement = document.querySelector('h1.title');
      const miniTitleP = document.querySelector('.mini-title-content p');
      if (titleElement && miniTitleP) {
        const titleText = titleElement.childNodes[0].textContent.trim();
        miniTitleP.textContent = titleText;

        // Only clone and add version control if title is not the demo title
        if (titleText !== 'A brief syntax demo') {
          // Clone version control dropdown if it exists
          const originalDropdown = document.querySelector('.navbar-nav .nav-item.dropdown:has(iconify-icon[icon="qlementine-icons:version-control-16"])');
          if (originalDropdown) {
            const clonedDropdown = originalDropdown.cloneNode(true);
            // Remove menu-text class but keep contents
            const menuTextSpan = clonedDropdown.querySelector('.menu-text');
            if (menuTextSpan) {
              menuTextSpan.classList.remove('menu-text');
            }
            // Add to mini version control container
            const versionContainer = document.querySelector('#mini-version-control');
            versionContainer.appendChild(clonedDropdown);
            // Initialize Bootstrap dropdown
            if (typeof bootstrap !== 'undefined') {
              const dropdownElement = clonedDropdown.querySelector('.dropdown-toggle');
              if (dropdownElement) {
                new bootstrap.Dropdown(dropdownElement);
              }
            }
          }
        }
      }

      const stickyMiniTitle = document.querySelector('.mini-title');

      // Navbar state management
      function updateNavbarState() {
        const isNavbarPinned = navbar.classList.contains('headroom--pinned');
        const isNavbarTop = !navbar.classList.contains('headroom--not-top');

        if (isNavbarPinned || isNavbarTop) {
          document.body.classList.add('navbar-visible');
        } else {
          document.body.classList.remove('navbar-visible');
        }
      }

      // Observe navbar class changes
      const navbarObserver = new MutationObserver(updateNavbarState);
      navbarObserver.observe(navbar, {
        attributes: true,
        attributeFilter: ['class']
      });
      updateNavbarState(); // Initial state

      // Mini title visibility functions
      function toggleMiniTitle(show) {
        document.body.classList.toggle('mini-title-visible', show);
        stickyMiniTitle.classList.toggle('visible', show);
      }

      // Create intersection observer with configurable options
      function createIntersectionObserver(type, rootMargin) {
        return new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            const currentRatio = entry.intersectionRatio;

            if (prevRatio[type] === 0 && currentRatio > 0) {
              toggleMiniTitle(false);
            } else if (prevRatio[type] > 0 && currentRatio === 0) {
              toggleMiniTitle(true);
            }

            prevRatio[type] = currentRatio;
          });
        }, {
          threshold: [0, 0.1],
          rootMargin
        });
      }

      // Create observers with different root margins
      const appearObserver = createIntersectionObserver('appear', '-48px');
      const disappearObserver = createIntersectionObserver('disappear', '48px');

      // Start observing title banner with both observers
      appearObserver.observe(titleBanner);
      disappearObserver.observe(titleBanner);

      // Cleanup
      window.addEventListener('beforeunload', () => {
        navbarObserver.disconnect();
        appearObserver.disconnect();
        disappearObserver.disconnect();
      });
    }
  });
</script>
<!-- version-in-title.html -->
<meta property="og:title" content="Do protein language models understand evolution? Mixed evidence from ancestral sequences and ESM2 –">
<meta property="og:description" content="">
<meta property="og:image" content="https://Arcadia-Science.github.io/2025-asr-plms/index_v1.0_files/figure-html/fig-1-output-1.png">
<meta property="og:image:height" content="538">
<meta property="og:image:width" content="485">
<meta name="twitter:title" content="Do protein language models understand evolution? Mixed evidence from ancestral sequences and ESM2 –">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://Arcadia-Science.github.io/2025-asr-plms/index_v1.0_files/figure-html/fig-1-output-1.png">
<meta name="twitter:image-height" content="538">
<meta name="twitter:image-width" content="485">
<meta name="twitter:card" content="summary_large_image">
</head><body class="nav-fixed quarto-light"><div id="title-version-control"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Find the original version control dropdown
    const originalDropdown = document.querySelector('.navbar-nav .nav-item.dropdown:has(iconify-icon[icon="qlementine-icons:version-control-16"])');
    if (originalDropdown && document.querySelector('.quarto-title')) {
      // Clone the dropdown structure
      const clonedDropdown = originalDropdown.cloneNode(true);
      // Update classes
      clonedDropdown.className = 'title-version-menu dropdown';
      // Remove the menu-text class but keep the span and its contents
      const menuTextSpan = clonedDropdown.querySelector('.menu-text');
      if (menuTextSpan) {
        menuTextSpan.classList.remove('menu-text');
      }
      // Find the title element
      const titleElement = document.querySelector('.quarto-title .title');
      if (titleElement) {
        // Add the version control to the container
        const versionContainer = document.getElementById('title-version-control');
        versionContainer.appendChild(clonedDropdown);
        titleElement.appendChild(versionContainer);

        // Check if this is the author guide and hide if it is
        if (titleElement.childNodes[0].textContent.trim() === 'A brief syntax demo') {
          versionContainer.style.display = 'none';
          versionContainer.style.visibility = 'hidden';
          versionContainer.style.pointerEvents = 'none';
        }

        // Ensure Bootstrap dropdown functionality works on the clone
        if (typeof bootstrap !== 'undefined') {
          const dropdownElement = clonedDropdown.querySelector('.dropdown-toggle');
          if (dropdownElement) {
            new bootstrap.Dropdown(dropdownElement);
          }
        }
      }
    }
  });
</script>
<!-- TODO: This solution currently generates the bibtex on the fly using a regex pattern. Ideally, the bibtex is a static file in the repository, similar to CITATION.cff. -->
<template id="citation-box-template">
  <div id="citation-popup" class="citation-popup">
    <div class="citation-popup-content">
      <div class="citation-header">
        <h4>Cite this pub</h4>
        <button id="close-citation-box" class="close-button" aria-label="Close citation box">×</button>
      </div>
      <div class="citation-tabs">
        <button class="citation-tab-button active" data-format="styled">Arcadia</button>
        <button class="citation-tab-button" data-format="bibtex">BibTeX</button>
      </div>
      <div class="citation-body">
        <div id="styled-citation" class="citation-content active">
          <p class="loading-text">Loading citation...</p>
        </div>
        <div id="bibtex-citation" class="citation-content">
          <pre class="loading-text">Loading citation...</pre>
        </div>
      </div>
      <div class="citation-footer">
        <button id="copy-citation-button" class="copy-button">
          <i class="bi bi-clipboard"></i> Copy to clipboard
        </button>
      </div>
    </div>
  </div>
</template>

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
<script>
  // Initialize citation functionality after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCitationBox);
  } else {
    initCitationBox();
  }

  function initCitationBox() {
    require.config({
      paths: {
        'js-yaml': 'https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min'
      }
    });

    require(['js-yaml'], function (jsyaml) {

      // Add citation box template to the document
      const template = document.getElementById('citation-box-template');
      const citationBoxContent = document.importNode(template.content, true);
      document.body.appendChild(citationBoxContent);

      // Find citation button
      const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
      let citeButton = null;
      for (const link of navLinks) {
        if (link.textContent && link.textContent.trim() === 'Cite this pub') {
          citeButton = link;
          break;
        }
      }

      // Reference elements (assuming they exist in the template)
      const citationPopup = document.getElementById('citation-popup');
      const closeButton = document.getElementById('close-citation-box');
      const copyButton = document.getElementById('copy-citation-button');
      const tabButtons = document.querySelectorAll('.citation-tab-button');
      const styledEl = document.getElementById('styled-citation');
      const bibtexEl = document.getElementById('bibtex-citation');

      let pubData = {};
      let isDataLoaded = false;

      // --- Function to load the citation data ---
      async function loadCitationData() {
        // Set loading text (will be replaced on success)
        styledEl.innerHTML = `<p class="loading-text">Loading citation...</p>`;
        bibtexEl.innerHTML = `<pre class="loading-text">Loading citation...</pre>`;

        // Fetch and parse CFF
        const siteRoot = (window.location.hostname.endsWith('github.io')) ? `/${window.location.pathname.split('/')[1]}` : '';
        const citationCffPath = `${siteRoot}/CITATION.cff`;
        const response = await fetch(citationCffPath);
        const text = await response.text();
        const cffData = jsyaml.load(text);

        const preferredCitation = cffData['preferred-citation'];
        const title = preferredCitation.title;
        const year = preferredCitation.year;
        const doi = preferredCitation.doi;
        const authors = preferredCitation.authors;

        pubData = {
          title: String(title).trim(),
          year: String(year).trim(),
          doi: String(doi).trim(),
          authors: []
        };

        for (const author of authors) {
          pubData.authors.push({
            family: String(author['family-names']).trim(),
            given: String(author['given-names']).trim()
          });
        }

        updateCitations();
        isDataLoaded = true;
      }

      function updateCitations() {
        const url = pubData.doi ? `https://doi.org/${pubData.doi}` : window.location.href;

        // Text citation
        const styledAuthors = pubData.authors.map(author => {
          const initials = author.given.split(/\s+/).map(name => name.charAt(0)).join('');
          return `${author.family} ${initials}`;
        }).join(', ');
        styledEl.innerHTML = `<p>${styledAuthors}. (${pubData.year}). ${pubData.title}. ${url}</p>`;

        // BibTeX citation
        const firstAuthor = pubData.authors[0]; // Assume at least one author
        const bibtexKey = `${firstAuthor.family.replace(/[^a-zA-Z0-9]/g, '')}${pubData.year}${pubData.title.split(' ')[0].replace(/[^a-zA-Z0-9]/g, '')}`;
        const escapedTitle = pubData.title.replace(/([{}])/g, '\\$1');
        const titleWithCaps = escapedTitle.replace(/\b([A-Z][a-zA-Z0-9'-]*)\b/g, '{$1}');
        const bibtexAuthors = pubData.authors.map(author => `${author.family}, ${author.given}`).join(' and ');

        const bibtexContentFinal = `@article{${bibtexKey},
    author = {${bibtexAuthors}},
    title = {${titleWithCaps}},
    journal = {Arcadia Science},
    year = {${pubData.year}},${pubData.doi ? `\n    doi = {${pubData.doi}},` : ''}
    url = {${url}}
}`;
        bibtexEl.innerHTML = `<pre>${bibtexContentFinal}</pre>`;
      }

      // --- Function to toggle the citation box ---
      function toggleCitationBox() {
        const isVisible = citationPopup.classList.contains('visible');
        if (!isVisible) {
          citationPopup.classList.add('visible');
          // Load data only once on first open
          if (!isDataLoaded) {
            loadCitationData(); // Assuming this will succeed
          }
        } else {
          citationPopup.classList.remove('visible');
        }
      }

      // --- Event listeners ---
      citeButton.addEventListener('click', function (e) {
        e.preventDefault();
        toggleCitationBox();
      });

      closeButton.addEventListener('click', function () {
        citationPopup.classList.remove('visible');
      });

      // Tab switching
      tabButtons.forEach(button => {
        button.addEventListener('click', function () {
          tabButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.citation-content').forEach(content => {
            content.classList.remove('active');
          });
          const format = this.getAttribute('data-format');
          document.getElementById(`${format}-citation`).classList.add('active');
        });
      });

      // Copy to clipboard functionality
      copyButton.addEventListener('click', function () {
        const activeTab = document.querySelector('.citation-tab-button.active');
        const activeFormat = activeTab.getAttribute('data-format');
        const contentEl = document.getElementById(`${activeFormat}-citation`);

        let textToCopy = '';
        if (activeFormat === 'bibtex') {
          textToCopy = contentEl.querySelector('pre').textContent.trim();
        } else {
          textToCopy = contentEl.querySelector('p').textContent.trim();
        }

        navigator.clipboard.writeText(textToCopy)
          .then(() => {
            copyButton.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
            setTimeout(() => {
              copyButton.innerHTML = '<i class="bi bi-clipboard"></i> Copy to clipboard';
            }, 2000);
          })
          .catch(err => {
            console.error('Failed to copy text to clipboard: ', err);
            copyButton.innerHTML = '<i class="bi bi-x-lg"></i> Failed';
            setTimeout(() => {
              copyButton.innerHTML = '<i class="bi bi-clipboard"></i> Copy to clipboard';
            }, 2000);
          });
      });

      // Close on escape key
      document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
          if (citationPopup && citationPopup.classList.contains('visible')) {
            citationPopup.classList.remove('visible');
          }
        }
      });

    });
  }

</script>


<link rel="stylesheet" href="assets/css/main.css">
<link rel="stylesheet" href="assets/css/citation-box.css">




<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-xl " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://research.arcadiascience.com/" class="navbar-brand navbar-brand-logo">
    <img src="./assets/logo_text.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-iconify-qlementine-iconsversion-control-16-" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text"><iconify-icon role="img" inline="" icon="qlementine-icons:version-control-16" aria-label="Icon version-control-16 from qlementine-icons Iconify.design set." title="Icon version-control-16 from qlementine-icons Iconify.design set."></iconify-icon></span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-iconify-qlementine-iconsversion-control-16-">    
        <li>
    <a class="dropdown-item" href="./index.html">
 <span class="dropdown-text">v1.1 (latest)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./index_v1.0.html">
 <span class="dropdown-text">v1.0</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="nrk:back" aria-label="Icon back from nrk Iconify.design set." title="Icon back from nrk Iconify.design set."></iconify-icon> Back to Pub</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./pages/FAQ.html"> 
<span class="menu-text">FAQ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./pages/SETUP.html"> 
<span class="menu-text">Reproduce this pub</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./#"> 
<span class="menu-text">Cite this pub</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./pages/CONTRIBUTING.html"> 
<span class="menu-text">Contribute</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://twitter.com/arcadiascience" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter-x"></i></a>
    <a href="https://github.com/Arcadia-Science/2025-asr-plms" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Do protein language models understand evolution? Mixed evidence from ancestral sequences and ESM2 –</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 1, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">Summary</div>
      <p>Protein language models are trained on evolutionarily related sequences, yet the extent to which they capture the underlying evolutionary relationships remains unclear. We explore this question using reconstructed ancestral protein sequences and the ESM2 protein language model.</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#purpose" id="toc-purpose" class="nav-link active" data-scroll-target="#purpose">Purpose</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#ada1-ancestral-reconstruction" id="toc-ada1-ancestral-reconstruction" class="nav-link" data-scroll-target="#ada1-ancestral-reconstruction">ADA1 ancestral reconstruction</a></li>
  <li><a href="#ada1-phylogeny" id="toc-ada1-phylogeny" class="nav-link" data-scroll-target="#ada1-phylogeny">ADA1 phylogeny</a></li>
  <li><a href="#loading-the-data" id="toc-loading-the-data" class="nav-link" data-scroll-target="#loading-the-data">Loading the data</a></li>
  <li><a href="#visualizing-esm2-pseudo-perplexity-vs.-evolutionary-distance" id="toc-visualizing-esm2-pseudo-perplexity-vs.-evolutionary-distance" class="nav-link" data-scroll-target="#visualizing-esm2-pseudo-perplexity-vs.-evolutionary-distance">Visualizing ESM2 pseudo-perplexity vs.&nbsp;evolutionary distance</a></li>
  <li><a href="#assessing-the-role-of-consensus-effects" id="toc-assessing-the-role-of-consensus-effects" class="nav-link" data-scroll-target="#assessing-the-role-of-consensus-effects">Assessing the role of consensus effects</a></li>
  <li><a href="#comparing-different-esm2-model-sizes" id="toc-comparing-different-esm2-model-sizes" class="nav-link" data-scroll-target="#comparing-different-esm2-model-sizes">Comparing different ESM2 model sizes</a></li>
  <li><a href="#second-example-gene-yeast-isomaltase" id="toc-second-example-gene-yeast-isomaltase" class="nav-link" data-scroll-target="#second-example-gene-yeast-isomaltase">Second example gene: Yeast isomaltase</a></li>
  <li><a href="#relationship-between-asr-confidence-and-esm2-pseudo-perplexity" id="toc-relationship-between-asr-confidence-and-esm2-pseudo-perplexity" class="nav-link" data-scroll-target="#relationship-between-asr-confidence-and-esm2-pseudo-perplexity">Relationship between ASR confidence and ESM2 pseudo-perplexity</a></li>
  <li><a href="#discussion-and-conclusions" id="toc-discussion-and-conclusions" class="nav-link" data-scroll-target="#discussion-and-conclusions">Discussion and conclusions</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<div class="callout callout-style-default callout-note callout-titled" title="AI usage disclosure">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
AI usage disclosure
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We used ChatGPT to help write code, clean up code, clarify and streamline text that we wrote, and suggest wording ideas from which we selected specific phrases.</p>
</div>
</div>
</div>
<section id="purpose" class="level2">
<h2 class="anchored" data-anchor-id="purpose">Purpose</h2>
<p>We wondered how protein language models trained on extant sequences would interpret plausible ancestral sequences. To explore this, we used ESM2 to evaluate maximum likelihood ancestral sequence reconstructions for two example gene families. We found that ESM2 often finds these ancestral sequences more plausible than extant descendants, and can distinguish between crude consensus ancestral sequences and more sophisticated maximum likelihood reconstructions. However, these patterns are context- and model-dependent, suggesting that further investigation is needed to determine which evolutionary relationships are truly captured by large protein language models like ESM2.</p>
<p>We are sharing these results to encourage further exploration of how large foundation models interpret the evolutionary relationships embedded in their training data. We think this could be useful to researchers interested in interrogating the implicit learning in large protein language models, like ESM2, and we propose that ancestral sequences offer a useful tool for this purpose.</p>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Protein language models have emerged as powerful tools for computational biology applications, including fitness prediction, generative protein design, structure prediction, and functional annotation. These models are trained on vast databases of naturally occurring protein sequences with the expectation that they will capture complex relationships underlying these sequences: from fundamental biophysical constraints to evolutionary pressures that have shaped modern proteins (<span class="citation" data-cites="lin_evolutionary-scale_2023">Lin et al. (<a href="#ref-lin_evolutionary-scale_2023" role="doc-biblioref">2023</a>)</span>, <span class="citation" data-cites="hayes_simulating_2025">Hayes et al. (<a href="#ref-hayes_simulating_2025" role="doc-biblioref">2025</a>)</span>, <span class="citation" data-cites="bhatnagar_scaling_2025">Bhatnagar et al. (<a href="#ref-bhatnagar_scaling_2025" role="doc-biblioref">2025</a>)</span>). However, the extent to which these models have learned genuine evolutionary principles versus surface-level sequence patterns, and how this varies across model architectures, remains an open question (<span class="citation" data-cites="lupo_protein_2022">Lupo et al. (<a href="#ref-lupo_protein_2022" role="doc-biblioref">2022</a>)</span>, <span class="citation" data-cites="ektefaie_sequence_2025">Ektefaie et al. (<a href="#ref-ektefaie_sequence_2025" role="doc-biblioref">2025</a>)</span>, <span class="citation" data-cites="tule_protein_2025">Tule et al. (<a href="#ref-tule_protein_2025" role="doc-biblioref">2025</a>)</span>, <span class="citation" data-cites="york_phylogenies_2025">York et al. (<a href="#ref-york_phylogenies_2025" role="doc-biblioref">2025</a>)</span>).</p>
<p>Ancestral sequence reconstruction (ASR) is a potentially useful framework for addressing this question. ASR employs statistical methods to infer the most probable protein sequences of extinct ancestral organisms based on phylogenetic relationships among extant sequences. While these reconstructions may not represent the exact sequences that existed in the past, they reflect evolutionarily plausible intermediates under established models of molecular evolution, and in many cases have been shown to fold and function (<span class="citation" data-cites="hochberg_reconstructing_2017">Hochberg and Thornton (<a href="#ref-hochberg_reconstructing_2017" role="doc-biblioref">2017</a>)</span>). This approach offers two key features for probing evolutionary knowledge encoded in protein language models. First, training datasets consist exclusively of extant sequences. Reconstructed ancestral sequences provide opportunities to evaluate the ability of these models to generalize to new sequences. Second, unlike other types of novel sequences, reconstructed ancestral sequences are unique in their evolutionary plausibility. ASR has been successfully applied to reconstruct and experimentally characterize diverse protein families, demonstrating that many reconstructed sequences represent functionally viable proteins (<span class="citation" data-cites="bridgham2006">Bridgham et al. (<a href="#ref-bridgham2006" role="doc-biblioref">2006</a>)</span>, <span class="citation" data-cites="voordeckers_reconstruction_2012">Voordeckers et al. (<a href="#ref-voordeckers_reconstruction_2012" role="doc-biblioref">2012</a>)</span>, <span class="citation" data-cites="wilson_using_2015">Wilson et al. (<a href="#ref-wilson_using_2015" role="doc-biblioref">2015</a>)</span>). Thus, ancestral proteins provide an opportunity to assess model confidence in evolutionarily plausible sequences never observed during training and infer the generalizability of evolutionary knowledge contained within pLMs.&nbsp;&nbsp;</p>
<p>Here, we focus on the ESM2 protein language model (<span class="citation" data-cites="lin_evolutionary-scale_2023">Lin et al. (<a href="#ref-lin_evolutionary-scale_2023" role="doc-biblioref">2023</a>)</span>), one of the most widely used and well-characterized models to date. ESM2 is trained on millions of extant protein sequences from UniRef and has been applied to a wide range of prediction tasks. It includes multiple model sizes, ranging from 8 million to 15 billion parameters, allowing us to examine how model behavior varies with scale. Using reconstructed ancestral protein sequences from two protein families, we find that ESM2 often assigns higher plausibility to ancestral sequences than to their extant descendants and can distinguish between crude consensus and maximum likelihood reconstructions, particularly for larger ESM2 model sizes. However, we find these relationships to vary significantly across ESM2 model sizes, suggesting the evolutionary learning is inconsistent. This supports the idea that large language models like ESM2 encode evolutionary signal, but indicates that further investigation is needed to determine the extent of this learning.</p>
</section>
<section id="ada1-ancestral-reconstruction" class="level2">
<h2 class="anchored" data-anchor-id="ada1-ancestral-reconstruction">ADA1 ancestral reconstruction</h2>
<p>We began this analysis with the <a href="https://www.uniprot.org/uniprotkb/P00813/entry">human protein ADA1</a>, an adenosine deaminase that plays a crucial role in purine metabolism. ADA1 offered several advantages as a test case: it is relatively small (363 amino acids), making computationally intensive pseudo-perplexity calculations more tractable, and is relatively well conserved across taxa, allowing for high-confidence sequence alignments and ancestral reconstructions.</p>
<p>We performed ASR on ADA1 by identifying homologs using Protein Cartography (v0.0.2) (<span class="citation" data-cites="avasthi_proteincartography_2023">Avasthi et al. (<a href="#ref-avasthi_proteincartography_2023" role="doc-biblioref">2023</a>)</span>), aligning proteins with MAFFT (<span class="citation" data-cites="katoh_mafft_2002">Katoh et al. (<a href="#ref-katoh_mafft_2002" role="doc-biblioref">2002</a>)</span>), building a phylogenetic tree with IQTree (<span class="citation" data-cites="nguyen_iq-tree_2015">Nguyen et al. (<a href="#ref-nguyen_iq-tree_2015" role="doc-biblioref">2015</a>)</span>), reconstructing maximum likelihood ancestral sequences using PAML (<span class="citation" data-cites="yang_paml_2007">Yang (<a href="#ref-yang_paml_2007" role="doc-biblioref">2007</a>)</span>), and inferring insertions and deletions using PastML (<span class="citation" data-cites="ishikawa_fast_2019">Ishikawa et al. (<a href="#ref-ishikawa_fast_2019" role="doc-biblioref">2019</a>)</span>) (as in <span class="citation" data-cites="orlandi_topiary_2023">Orlandi et al. (<a href="#ref-orlandi_topiary_2023" role="doc-biblioref">2023</a>)</span>).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We performed ancestral reconstructions using a separate notebook, <a href="https://github.com/Arcadia-Science/2025-asr-plms/blob/main/ASR/ASR_notebook.ipynb">ASR/ASR_notebook.ipynb</a>. This step was conducted separately to keep the main analysis here focused and uncluttered, as ancestral reconstruction involves a multi-stage pipeline with its own set of dependencies and intermediate steps. <a href="https://github.com/Arcadia-Science/2025-asr-plms/blob/main/ASR/README.ipynb">ASR/README.md</a> provides instructions for reproducing the ancestral sequences used in the present analysis.</p>
</div>
</div>
<p>To determine the confidence of the ESM2 model in these ancestral sequences, we used pseudo-perplexity as our primary metric (<span class="citation" data-cites="lin_evolutionary-scale_2023">Lin et al. (<a href="#ref-lin_evolutionary-scale_2023" role="doc-biblioref">2023</a>)</span> , <span class="citation" data-cites="salazar_masked_2020">Salazar et al. (<a href="#ref-salazar_masked_2020" role="doc-biblioref">2020</a>)</span>). Pseudo-perplexity quantifies how well a protein language model can predict each amino acid in a sequence given the surrounding context, essentially measuring the model’s “surprise” at encountering each individual residue. A pseudo-perplexity value near 20 indicates that the model is highly uncertain and assigns roughly equal probability to all 20 amino acids, while a value closer to 1 indicates strong confidence in its prediction. In practice, pseudo-perplexity is computed by summing the negative log-likelihoods of each residue prediction across the entire sequence, yielding a sequence-level score that reflects how grammatically consistent a model believes the sequence to be based on its training on natural proteins. Lower pseudo-perplexity values, therefore, suggest higher plausibility under the model’s learned distribution. By analyzing pseudo-perplexity scores across ancestral sequences with different evolutionary age, we aimed to assess whether protein language models can infer the plausibility of ancestrally reconstructed sequences and how their confidence varies across evolutionary time.</p>
</section>
<section id="ada1-phylogeny" class="level2">
<h2 class="anchored" data-anchor-id="ada1-phylogeny">ADA1 phylogeny</h2>
<p>We first wanted to assess how ESM2 pseudo-perplexity varies between ancestral and native sequences and the effect of ancestral age. To start, we looked at the human ADA1 protein P00813.</p>
<div id="cell-fig-1" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arcadia_pycolor <span class="im">as</span> apc</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.analysis.data_processing <span class="im">import</span> plot_image_with_arrow_and_circles, plot_image_with_arrows</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>apc.mpl.setup()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>img_path <span class="op">=</span> <span class="st">"images/ADA1_tree.png"</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>plot_image_with_arrows(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    img_path,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    x_starts<span class="op">=</span>[<span class="fl">0.73</span>],</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    x_ends<span class="op">=</span>[<span class="fl">0.60</span>],</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    arrow_ys<span class="op">=</span>[<span class="fl">0.045</span>],</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>[<span class="st">"P00813_Homo_sapiens"</span>],</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    text_offsets<span class="op">=</span>[<span class="fl">0.01</span>],</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_v1.0_files/figure-html/fig-1-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Phylogenetic tree of ADA1 homologs with location of human ADA1 indicated by arrow.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We determined every ancestral node leading to this extant leaf and its maximum likelihood ancestral sequence, as shown in the example below.</p>
<div id="cell-fig-2" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>node_img_path <span class="op">=</span> <span class="st">"images/tree_nodes_example.png"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>plot_image_with_arrow_and_circles(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    img_path<span class="op">=</span>node_img_path,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    x_start<span class="op">=</span><span class="fl">0.97</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    x_end<span class="op">=</span><span class="fl">0.89</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    arrow_y<span class="op">=</span><span class="fl">0.01</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    circle_positions<span class="op">=</span>[</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.771</span>, <span class="fl">0.025</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.70</span>, <span class="fl">0.058</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.675</span>, <span class="fl">0.105</span>),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.604</span>, <span class="fl">0.155</span>),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.553</span>, <span class="fl">0.197</span>),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.48</span>, <span class="fl">0.23</span>),</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.335</span>, <span class="fl">0.27</span>),</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.285</span>, <span class="fl">0.335</span>),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.178</span>, <span class="fl">0.41</span>),</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.146</span>, <span class="fl">0.515</span>),</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">0.066</span>, <span class="fl">0.625</span>),</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    circle_radius<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_v1.0_files/figure-html/fig-2-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Example of all ancestral nodes (orange circles) on the lineage of an example leaf of interest (orange arrow). The basal node of the tree was not included, as our ASR pipeline does not reconstruct this node.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="loading-the-data" class="level2">
<h2 class="anchored" data-anchor-id="loading-the-data">Loading the data</h2>
<p>We calculated pseudo-perplexity scores using the 650M ESM2 model for relevant ancestral sequences and extant sequences in our dataset to begin inferring model confidence of reconstructed sequences.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We performed pseudo-perplexity calculations using the script <a href="https://github.com/Arcadia-Science/2025-asr-plms/blob/main/ESM2_scoring/esm2_pppl_calculator.py"><code>ESM2_scoring/esm2_pppl_calculator.py</code></a>. This step was conducted separately because it required GPU compute for efficient execution. <a href="https://github.com/Arcadia-Science/2025-asr-plms/blob/main/ESM2_scoring/esm2_pppl_calculator.py">ESM2_scoring/README.md</a> provides instructions for reproducing the perplexity scores used in the present analysis.</p>
</div>
</div>
<p>In addition to pseudo-perplexity values, we extracted the mean posterior probabilities for each ancestral reconstruction from the PAML output. Posterior probability in this context represents the statistical confidence of the maximum likelihood reconstruction.&nbsp; Specifically, it quantifies the probability that each amino acid at each position in the ancestral sequence is correctly inferred given the appropriate phylogenetic model and observed extant sequences. Higher values, close to 1.0, indicate high confidence in the protein reconstruction.</p>
<p>To quantify evolutionary divergence, we calculated the total branch length from the root to each ancestral node and extant leaf in our phylogenetic tree. This allowed us to examine how ESM2 confidence varies across evolutionary age.</p>
<div id="1af4d91c" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Bio <span class="im">import</span> Phylo</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>esm2_dir <span class="op">=</span> Path(<span class="st">"ESM2_scoring/outputs/"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Import ADA1 sequences scored for ESM2 pppl</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>all_scores <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"ADA1_all_esm2_scores_650M.csv"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>all_scores <span class="op">=</span> all_scores[[<span class="st">"sequence_id"</span>, <span class="st">"sequence"</span>, <span class="st">"pseudo_perplexity"</span>]]</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve ML posterior probabilities from ASR run</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>ml_probs_json <span class="op">=</span> Path(<span class="st">"ASR/ADA1_ASR/outputs/posterior_probabilities_no_gaps.json"</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(ml_probs_json) <span class="im">as</span> f:</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    probs_dict <span class="op">=</span> json.load(f)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add posterior probabilities to dataframe</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>all_scores[<span class="st">"ML prob"</span>] <span class="op">=</span> all_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.mean([<span class="bu">max</span>(x) <span class="cf">for</span> x <span class="kw">in</span> probs_dict[x]]) <span class="cf">if</span> x <span class="kw">in</span> probs_dict <span class="cf">else</span> np.nan</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Import phylogenetic tree to infer ancestors of leaf of interest</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>tree_file <span class="op">=</span> <span class="st">"ASR/ADA1_ASR/outputs/ancestor_tree.txt"</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>tree <span class="op">=</span> Phylo.read(tree_file, <span class="st">"newick"</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the branch length to the root for every ancestor and native sequence</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.analysis.data_processing <span class="im">import</span> (</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    calc_branch_length_to_root_leaf,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    calc_branch_length_to_root_node,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>all_scores[<span class="st">"bl_to_root"</span>] <span class="op">=</span> all_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: calc_branch_length_to_root_node(tree, x[<span class="dv">4</span>:])</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x.startswith(<span class="st">"node"</span>)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> calc_branch_length_to_root_leaf(tree, x)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualizing-esm2-pseudo-perplexity-vs.-evolutionary-distance" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="visualizing-esm2-pseudo-perplexity-vs.-evolutionary-distance">Visualizing ESM2 pseudo-perplexity vs.&nbsp;evolutionary distance</h2>
<p>Plotting ESM2 pseudo-perplexity scores against evolutionary distance from the tree root allows us to examine the effect of both ancestral age (distance to tree root) and reconstruction confidence (posterior probability) on the pseudo-perplexity score.</p>
<div id="cell-fig-3" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.analysis.data_processing <span class="im">import</span> get_node_labels_leaf_to_root, plot_evo_path</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>plot_evo_path(all_scores, tree, <span class="st">"P00813_Homo_sapiens"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_v1.0_files/figure-html/fig-3-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: ESM2 pseudo-perplexity scores for ADA1 sequences, colored by ML posterior probability bin. The x-axis shows the branch length to the root node of the tree, with the extant sequence on the far right (orange). The y-axis shows ESM2 pseudo-perplexity score.
</figcaption>
</figure>
</div>
</div>
</div>
<p>ESM2 assigns lower pseudo-perplexity scores to recent ancestral sequences compared to the extant human sequence, suggesting that the model considers these reconstructed ancestors more plausible than the native sequence. This is intriguing given that these ancestral sequences were never present in the training data, and may indicate that ESM2 has inferred specific evolutionary patterns sufficiently to recognize some high-confidence ancestral reconstructions as sound.</p>
<p>However, as evolutionary distance increases, pseudo-perplexity scores rise and eventually surpass the native score. This suggests the model finds these basal ancestors less plausible than the native and more recent ancestral sequences.&nbsp;</p>
<p>We wondered how general this phenomenon was, so we examined three additional extant leaves in our ADA1 phylogenetic tree and ancestral nodes on their respective lineages.</p>
<div id="cell-fig-4" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>plot_image_with_arrows(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    img_path,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    x_starts<span class="op">=</span>[<span class="fl">0.73</span>, <span class="fl">0.89</span>, <span class="fl">0.86</span>, <span class="fl">0.78</span>],</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    x_ends<span class="op">=</span>[<span class="fl">0.60</span>, <span class="fl">0.76</span>, <span class="fl">0.73</span>, <span class="fl">0.65</span>],</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    arrow_ys<span class="op">=</span>[<span class="fl">0.045</span>, <span class="fl">0.44</span>, <span class="fl">0.305</span>, <span class="fl">0.745</span>],</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>[</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"P00813_Homo_sapiens"</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    text_offsets<span class="op">=</span>[<span class="fl">0.01</span>, <span class="fl">0.01</span>, <span class="fl">0.01</span>, <span class="fl">0.01</span>],</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-4" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_v1.0_files/figure-html/fig-4-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Phylogenetic tree of ADA1 with additional extant leaf positions indicated by arrows.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell page-columns page-full" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>plot_evo_path(all_scores, tree, <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>plot_evo_path(all_scores, tree, <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>plot_evo_path(all_scores, tree, <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-5" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="6">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-5-1" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-5-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-5-output-1.png" id="fig-5-1" class="img-fluid figure-img column-body" data-ref-parent="fig-5">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-5-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-5-2" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-5-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-5-output-2.png" id="fig-5-2" class="img-fluid figure-img column-body" data-ref-parent="fig-5">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-5-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-5-3" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-5-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-5-output-3.png" id="fig-5-3" class="img-fluid figure-img column-body" data-ref-parent="fig-5">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-5-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: ESM2 pseudo-perplexity vs distance to tree root for three additional species lineages.
</figcaption>
</figure>
</div>
</div>
<p>Here we see a similar pattern: recent ancestors show lower pseudo-perplexity scores than their native descendants, but these scores increase for the oldest ancestors. Unlike human ADA1, however, none of these other ancestors showed higher pseudo-perplexity scores than their native sequences, suggesting this isn’t universal. This may reflect the lower baseline score of human ADA1 compared to the others, perhaps due to over-representation of human and closely related sequences in the training set compared to these other species. However, we consistently observe that ESM2 considers many ancestral sequences more plausible than native sequences across different species.</p>
</section>
<section id="assessing-the-role-of-consensus-effects" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="assessing-the-role-of-consensus-effects">Assessing the role of consensus effects</h2>
<p>We wondered whether ESM’s general preference for ancestral sequences reflects primarily a consensus effect in these models. Maximum likelihood ancestral reconstructions, while statistically based, often favor amino acids that are common among descendant sequences, potentially creating sequences that align with the frequency distributions in the ESM2 training data. Therefore, ESM2 might prefer these sequences simply because they contain high-frequency amino acids.</p>
<p>To test this hypothesis, we generated “consensus ancestors” as controls. For each ancestral node, we identified all extant sequences descending from that node. We constructed a consensus sequence by choosing the most frequent amino acid found at each position in the alignment. This relatively simple approach differs fundamentally from maximum likelihood reconstruction, which incorporates evolutionary models, branch lengths, and substitution matrices to infer the most probable ancestral state given the entire phylogenetic context.</p>
<div id="54b05f93" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Bio.Seq <span class="im">import</span> Seq</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Bio.SeqRecord <span class="im">import</span> SeqRecord</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.analysis.data_processing <span class="im">import</span> generate_node_consensus, get_node_labels_leaf_to_root</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>leaves_of_interest <span class="op">=</span> [</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"P00813_Homo_sapiens"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>ancestors_of_interest <span class="op">=</span> []</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry <span class="kw">in</span> leaves_of_interest:</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    ancestors_of_interest.extend(get_node_labels_leaf_to_root(tree, entry))</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>ancestors_of_interest <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(ancestors_of_interest))</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>alignment_file <span class="op">=</span> <span class="st">"ASR/ADA1_ASR/outputs/ADA1_curated_022525_under420_recoded_mafft.fa"</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>name_conv_dict <span class="op">=</span> <span class="st">"ASR/ADA1_ASR/outputs/recoding_dict.txt"</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>gap_dict_json <span class="op">=</span> <span class="st">"ASR/ADA1_ASR/outputs/gap_positions.json"</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>consensus_seq_file <span class="op">=</span> esm2_dir.parent <span class="op">/</span> <span class="st">"inputs"</span> <span class="op">/</span> <span class="st">"consensus_ADA1_ancestors.fa"</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>records <span class="op">=</span> []</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry <span class="kw">in</span> ancestors_of_interest:</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    consensus_seq <span class="op">=</span> generate_node_consensus(</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        tree, entry, alignment_file, name_conv_dict, gap_dict_json</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> entry <span class="op">+</span> <span class="st">"_consensus"</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    record <span class="op">=</span> SeqRecord(Seq(consensus_seq), <span class="bu">id</span><span class="op">=</span>name, description<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    records.append(record)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then calculated pseudo-perplexity scores for these consensus ancestors using the ESM2 650M-parameter model.</p>
<div id="af8ec43d" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># retrieve esm2 scores for consensus seqs</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>consensus_file <span class="op">=</span> esm2_dir <span class="op">/</span> <span class="st">"consensus_ADA1_ancestors_esm2_scores_650M.csv"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>consensus_scores <span class="op">=</span> pd.read_csv(consensus_file)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>consensus_scores[<span class="st">"orig_id"</span>] <span class="op">=</span> consensus_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: x.replace(<span class="st">"_consensus"</span>, <span class="st">""</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>consensus_scores <span class="op">=</span> consensus_scores[[<span class="st">"orig_id"</span>, <span class="st">"sequence"</span>, <span class="st">"pseudo_perplexity"</span>]]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>consensus_scores <span class="op">=</span> consensus_scores.rename(</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sequence"</span>: <span class="st">"consensus_seq"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pseudo_perplexity"</span>: <span class="st">"consensus_pppl"</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"orig_id"</span>: <span class="st">"sequence_id"</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co"># add new consensus seqs and scores to scores df</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>all_scores <span class="op">=</span> all_scores.merge(consensus_scores, how<span class="op">=</span><span class="st">"left"</span>, on<span class="op">=</span><span class="st">"sequence_id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below, we compared the ESM2 pseudo-perplexity scores of these consensus ancestors to the scores of genuine maximum likelihood ancestors for the four extant sequences we previously examined.&nbsp;</p>
<div class="cell page-columns page-full" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.analysis.data_processing <span class="im">import</span> plot_evo_path_quiver</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>plot_evo_path_quiver(all_scores, tree, <span class="st">"P00813_Homo_sapiens"</span>, <span class="st">"upper right"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>plot_evo_path_quiver(all_scores, tree, <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>plot_evo_path_quiver(all_scores, tree, <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>plot_evo_path_quiver(all_scores, tree, <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-6" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="9">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-6-1" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-6-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-6-output-1.png" id="fig-6-1" class="img-fluid figure-img column-body" data-ref-parent="fig-6">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-6-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-6-2" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-6-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-6-output-2.png" id="fig-6-2" class="img-fluid figure-img column-body" data-ref-parent="fig-6">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-6-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-6-3" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-6-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-6-output-3.png" id="fig-6-3" class="img-fluid figure-img column-body" data-ref-parent="fig-6">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-6-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-6-4" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-6-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-6-output-4.png" id="fig-6-4" class="img-fluid figure-img column-body" data-ref-parent="fig-6">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-6-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: ESM2 pseudo-perplexity (pppl) scores for consensus and maximum likelihood (ML) ancestors of ADA1, with arrows indicating which ancestor has the lower pseudo-perplexity score.
</figcaption>
</figure>
</div>
</div>
<p>Maximum likelihood ancestors frequently show lower pseudo-perplexity scores than their corresponding consensus ancestors. However, both types of ancestral sequences often scored lower than extant sequences, indicating that a consensus effect partially drives the observed preference for ancestral sequences.</p>
<p>However, the relationship between maximum likelihood and consensus ancestors varies with evolutionary distance. For recent ancestors, maximum likelihood sequences consistently outperform consensus ancestors, suggesting that ESM2 has learned to recognize evolutionarily informed reconstructions as more plausible than simple frequency-based sequences. This indicates that the model has internalized aspects of evolutionary relationships beyond mere amino acid frequency distributions. However, this relationship reverses for more ancient ancestors, where consensus sequences often achieve lower pseudo-perplexity scores than maximum likelihood reconstructions. These ancient reconstructions also exhibit lower posterior probabilities, so this reversal may reflect increased uncertainty and potential errors in the maximum likelihood reconstructions. Alternatively, this behavior could reflect over-fitting to native sequences, given that consensus sequences likely more closely match the frequency distributions of the training set. While it’s difficult to distinguish between these two factors for the oldest ancestors, for more recent ancestors it’s clear that ESM2 can infer that maximum likelihood ancestors are significantly more plausible than crude consensus ancestors.</p>
</section>
<section id="comparing-different-esm2-model-sizes" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="comparing-different-esm2-model-sizes">Comparing different ESM2 model sizes</h2>
<p>We were curious to know how much of the evolutionary information ESM2 seems to be learning is consistent across different model sizes or whether this information is only captured in large models. To investigate this, we repeated the above analysis with different ESM2 model sizes: 8M, 35M, 150M, and 3B parameters (in addition to the previously shown 650M).&nbsp;</p>
<div id="ce7366a4" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>small_model_scores <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"ADA1_all_esm2_scores_8M.csv"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>med_model_scores <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"ADA1_all_esm2_scores_35M.csv"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>large_model_scores <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"ADA1_all_esm2_scores_150M.csv"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>huge_model_scores <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"ADA1_all_esm2_scores_3B.csv"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>small_model_scores[<span class="st">"ML prob"</span>] <span class="op">=</span> small_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.mean([<span class="bu">max</span>(x) <span class="cf">for</span> x <span class="kw">in</span> probs_dict[x]]) <span class="cf">if</span> x <span class="kw">in</span> probs_dict <span class="cf">else</span> np.nan</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>small_model_scores[<span class="st">"bl_to_root"</span>] <span class="op">=</span> small_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: calc_branch_length_to_root_node(tree, x[<span class="dv">4</span>:])</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x.startswith(<span class="st">"node"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> calc_branch_length_to_root_leaf(tree, x)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>med_model_scores[<span class="st">"ML prob"</span>] <span class="op">=</span> med_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.mean([<span class="bu">max</span>(x) <span class="cf">for</span> x <span class="kw">in</span> probs_dict[x]]) <span class="cf">if</span> x <span class="kw">in</span> probs_dict <span class="cf">else</span> np.nan</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>med_model_scores[<span class="st">"bl_to_root"</span>] <span class="op">=</span> med_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: calc_branch_length_to_root_node(tree, x[<span class="dv">4</span>:])</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x.startswith(<span class="st">"node"</span>)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> calc_branch_length_to_root_leaf(tree, x)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>large_model_scores[<span class="st">"ML prob"</span>] <span class="op">=</span> large_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.mean([<span class="bu">max</span>(x) <span class="cf">for</span> x <span class="kw">in</span> probs_dict[x]]) <span class="cf">if</span> x <span class="kw">in</span> probs_dict <span class="cf">else</span> np.nan</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>large_model_scores[<span class="st">"bl_to_root"</span>] <span class="op">=</span> large_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: calc_branch_length_to_root_node(tree, x[<span class="dv">4</span>:])</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x.startswith(<span class="st">"node"</span>)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> calc_branch_length_to_root_leaf(tree, x)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>huge_model_scores[<span class="st">"ML prob"</span>] <span class="op">=</span> huge_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.mean([<span class="bu">max</span>(x) <span class="cf">for</span> x <span class="kw">in</span> probs_dict[x]]) <span class="cf">if</span> x <span class="kw">in</span> probs_dict <span class="cf">else</span> np.nan</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>huge_model_scores[<span class="st">"bl_to_root"</span>] <span class="op">=</span> huge_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: calc_branch_length_to_root_node(tree, x[<span class="dv">4</span>:])</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x.startswith(<span class="st">"node"</span>)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> calc_branch_length_to_root_leaf(tree, x)</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then plot the same relationship between ESM2 pseudo-perplexity and distance to tree root for these different model sizes to see if they exhibit similar behavior.</p>
<div class="cell page-columns page-full" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.analysis.data_processing <span class="im">import</span> plot_multiple_evo_lines</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>plot_multiple_evo_lines(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        (small_model_scores, <span class="st">"P00813_Homo_sapiens"</span>, <span class="st">"8M"</span>),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        (med_model_scores, <span class="st">"P00813_Homo_sapiens"</span>, <span class="st">"35M"</span>),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        (large_model_scores, <span class="st">"P00813_Homo_sapiens"</span>, <span class="st">"150M"</span>),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        (all_scores, <span class="st">"P00813_Homo_sapiens"</span>, <span class="st">"650M"</span>),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        (huge_model_scores, <span class="st">"P00813_Homo_sapiens"</span>, <span class="st">"3B"</span>),</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    tree,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    normalize<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>plot_multiple_evo_lines(</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        (small_model_scores, <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>, <span class="st">"8M"</span>),</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        (med_model_scores, <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>, <span class="st">"35M"</span>),</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        (large_model_scores, <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>, <span class="st">"150M"</span>),</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        (all_scores, <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>, <span class="st">"650M"</span>),</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        (huge_model_scores, <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>, <span class="st">"3B"</span>),</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    tree,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    normalize<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>plot_multiple_evo_lines(</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        (small_model_scores, <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>, <span class="st">"8M"</span>),</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        (med_model_scores, <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>, <span class="st">"35M"</span>),</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        (large_model_scores, <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>, <span class="st">"150M"</span>),</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        (all_scores, <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>, <span class="st">"650M"</span>),</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        (huge_model_scores, <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>, <span class="st">"3B"</span>),</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    tree,</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    normalize<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>plot_multiple_evo_lines(</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        (small_model_scores, <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>, <span class="st">"8M"</span>),</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        (med_model_scores, <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>, <span class="st">"35M"</span>),</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        (large_model_scores, <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>, <span class="st">"150M"</span>),</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        (all_scores, <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>, <span class="st">"650M"</span>),</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        (huge_model_scores, <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>, <span class="st">"3B"</span>),</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    tree,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    normalize<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-7" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="11">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-7-1" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-7-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-7-output-1.png" id="fig-7-1" class="img-fluid figure-img column-body" data-ref-parent="fig-7">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-7-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-7-2" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-7-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-7-output-2.png" id="fig-7-2" class="img-fluid figure-img column-body" data-ref-parent="fig-7">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-7-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-7-3" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-7-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-7-output-3.png" id="fig-7-3" class="img-fluid figure-img column-body" data-ref-parent="fig-7">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-7-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-7-4" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-7-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-7-output-4.png" id="fig-7-4" class="img-fluid figure-img column-body" data-ref-parent="fig-7">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-7-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: ESM2 pseudo-perplexity vs distance to tree root for five different ESM2 model sizes for four species lineages.
</figcaption>
</figure>
</div>
</div>
<p>Larger models consistently produce overall lower pseudo-perplexity scores, reflecting their improved ability to learn protein sequence patterns. However, the relationship between pseudo-perplexity and evolutionary age varies across model sizes. To facilitate easier comparison across models, we normalized all pseudo-perplexity values to each model’s extant sequence pseudo-perplexity score.</p>
<div class="cell page-columns page-full" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>plot_multiple_evo_lines(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        (small_model_scores, <span class="st">"P00813_Homo_sapiens"</span>, <span class="st">"8M"</span>),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        (med_model_scores, <span class="st">"P00813_Homo_sapiens"</span>, <span class="st">"35M"</span>),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        (large_model_scores, <span class="st">"P00813_Homo_sapiens"</span>, <span class="st">"150M"</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        (all_scores, <span class="st">"P00813_Homo_sapiens"</span>, <span class="st">"650M"</span>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        (huge_model_scores, <span class="st">"P00813_Homo_sapiens"</span>, <span class="st">"3B"</span>),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    tree,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>plot_multiple_evo_lines(</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        (small_model_scores, <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>, <span class="st">"8M"</span>),</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        (med_model_scores, <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>, <span class="st">"35M"</span>),</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        (large_model_scores, <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>, <span class="st">"150M"</span>),</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        (all_scores, <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>, <span class="st">"650M"</span>),</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        (huge_model_scores, <span class="st">"A0A8S4BYQ7_Menidia_menidia"</span>, <span class="st">"3B"</span>),</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    tree,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>plot_multiple_evo_lines(</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        (small_model_scores, <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>, <span class="st">"8M"</span>),</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        (med_model_scores, <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>, <span class="st">"35M"</span>),</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        (large_model_scores, <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>, <span class="st">"150M"</span>),</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        (all_scores, <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>, <span class="st">"650M"</span>),</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        (huge_model_scores, <span class="st">"A0A673JME8_Sinocyclocheilus_rhinocerous"</span>, <span class="st">"3B"</span>),</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    tree,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>plot_multiple_evo_lines(</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>        (small_model_scores, <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>, <span class="st">"8M"</span>),</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>        (med_model_scores, <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>, <span class="st">"35M"</span>),</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        (large_model_scores, <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>, <span class="st">"150M"</span>),</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        (all_scores, <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>, <span class="st">"650M"</span>),</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        (huge_model_scores, <span class="st">"A0A8J6K0P8_Eleutherodactylus_coqui"</span>, <span class="st">"3B"</span>),</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    tree,</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-8" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="12">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-8-1" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-8-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-8-output-1.png" id="fig-8-1" class="img-fluid figure-img column-body" data-ref-parent="fig-8">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-8-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-8-2" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-8-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-8-output-2.png" id="fig-8-2" class="img-fluid figure-img column-body" data-ref-parent="fig-8">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-8-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-8-3" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-8-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-8-output-3.png" id="fig-8-3" class="img-fluid figure-img column-body" data-ref-parent="fig-8">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-8-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-8-4" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-8-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-8-output-4.png" id="fig-8-4" class="img-fluid figure-img column-body" data-ref-parent="fig-8">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-8-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Normalized ESM2 pseudo-perplexity vs distance to tree root for different ESM2 model sizes. For each species lineage, the pseudo-perplexity scores for each model are normalized to the score for the extant sequence for that model size.
</figcaption>
</figure>
</div>
</div>
<p>This normalization reveals distinct differences in how models of varying sizes score ancestors of different ages. The larger models (650M and 3B parameters) show dramatic increases in pseudo-perplexity for the oldest ancestors compared to recent ancestors or extant sequences, while the smallest models show only gradual increases for these ancient sequences. Conversely, the largest models demonstrate the most significant decreases in pseudo-perplexity for the most recent ancestors relative to extant sequences.</p>
<p>These patterns suggest the models learn evolutionary principles to markedly different extents. The largest models disfavor low-confidence reconstructions while favoring high-confidence reconstructions. This could reflect genuine evolutionary learning or overfitting to native-like sequences. Meanwhile, the smallest models show minimal pseudo-perplexity differences from native to deepest ancestors, though their absolute scores remain relatively high (&gt; 10) compared to the much lower scores (&lt; 3) of larger models.</p>
<p>Most importantly, these results demonstrate that ESM2 model size is critically essential for evolutionary analysis. Depending on which model size you use for this analysis, you could reach vastly different conclusions: that all ancestors are more plausible than native sequences, that some ancestors are more plausible, that ancestors and native sequences are similarly plausible, or that ancestral age strongly affects plausibility.</p>
</section>
<section id="second-example-gene-yeast-isomaltase" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="second-example-gene-yeast-isomaltase">Second example gene: Yeast isomaltase</h2>
<p>We examined <a href="https://www.uniprot.org/uniprotkb/A0A420MWB1/entry">yeast isomaltase</a> to explore whether these findings generalized to other proteins. Isomaltase produced high-quality alignments and phylogenetic trees, was relatively small for pseudo-perplexity calculations (589 amino acids), and showed a phylogenetic structure similar to ADA1. Ancestral reconstructions displayed high confidence toward terminal leaves and lower (but still reasonable) confidence at basal nodes. While not all gene phylogenies follow this pattern, we wanted to understand how ESM2 behaves with this fairly typical phylogenetic structure. Future work could expand this analysis to genes with more diverse phylogenetic patterns to examine how pseudo-perplexity varies across different tree topologies.</p>
<p>We selected three extant leaves to interrogate in the same manner as above, their location on the isomaltase phylogenetic tree is shown below.</p>
<div id="cell-fig-9" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>img_path <span class="op">=</span> <span class="st">"images/isomaltase_tree.png"</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>plot_image_with_arrows(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    img_path,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    x_starts<span class="op">=</span>[<span class="fl">0.94</span>, <span class="fl">0.96</span>, <span class="fl">0.88</span>],</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    x_ends<span class="op">=</span>[<span class="fl">0.81</span>, <span class="fl">0.83</span>, <span class="fl">0.75</span>],</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    arrow_ys<span class="op">=</span>[<span class="fl">0.105</span>, <span class="fl">0.343</span>, <span class="fl">0.56</span>],</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>[</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"A0A420MWB1_Fusarium_oxysporum"</span>,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"A0A177DQL5_Alternaria_alternata"</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"A0A4T0C5S8_Aureobasidium_pullulans"</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    text_offsets<span class="op">=</span>[<span class="fl">0.01</span>, <span class="fl">0.01</span>, <span class="fl">0.01</span>],</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-9" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_v1.0_files/figure-html/fig-9-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Phylogenetic tree of isomaltase with extant leaf positions indicated by arrows.
</figcaption>
</figure>
</div>
</div>
</div>
<p>It’s worth noting that the scale of substitutions per site is much smaller for isomaltase than ADA1, indicating that these sequences are less divergent (maximum branch length ~1.5 vs.&nbsp;~2.5 for ADA1). Correspondingly, the overall ASR mean posterior probabilities are also higher.</p>
<p>We can then plot the ESM2 pseudo-perplexity (650M-parameter model) compared to the distance to tree root as we did for ADA1 for all three leaves.</p>
<div id="00cca76b" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get ESM2 scores for isomaltase</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>iso_scores <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"isomaltase_all_esm2_scores_650M.csv"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># retrieve the dictionary of probabilities from PAML output</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>ml_probs_json <span class="op">=</span> <span class="st">"ASR/Isomaltase_ASR/outputs/posterior_probabilities_no_gaps.json"</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>ml_probs_json <span class="op">=</span> Path(ml_probs_json)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(ml_probs_json) <span class="im">as</span> f:</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    iso_probs_dict <span class="op">=</span> json.load(f)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>iso_scores[<span class="st">"ML prob"</span>] <span class="op">=</span> iso_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.mean([<span class="bu">max</span>(x) <span class="cf">for</span> x <span class="kw">in</span> iso_probs_dict[x]]) <span class="cf">if</span> x <span class="kw">in</span> iso_probs_dict <span class="cf">else</span> np.nan</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>tree_file <span class="op">=</span> <span class="st">"ASR/Isomaltase_ASR/outputs/ancestor_tree.txt"</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>iso_tree <span class="op">=</span> Phylo.read(tree_file, <span class="st">"newick"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>iso_scores[<span class="st">"bl_to_root"</span>] <span class="op">=</span> iso_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: calc_branch_length_to_root_node(iso_tree, x[<span class="dv">4</span>:])</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x.startswith(<span class="st">"node"</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> calc_branch_length_to_root_leaf(iso_tree, x)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-execution_count="15">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>plot_evo_path(iso_scores, iso_tree, <span class="st">"A0A420MWB1_Fusarium_oxysporum"</span>, labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>plot_evo_path(iso_scores, iso_tree, <span class="st">"A0A177DQL5_Alternaria_alternata"</span>, labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>plot_evo_path(iso_scores, iso_tree, <span class="st">"A0A4T0C5S8_Aureobasidium_pullulans"</span>, labels<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-10" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="15">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-10-1" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-10-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-10-output-1.png" id="fig-10-1" class="img-fluid figure-img column-body" data-ref-parent="fig-10">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-10-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-10-2" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-10-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-10-output-2.png" id="fig-10-2" class="img-fluid figure-img column-body" data-ref-parent="fig-10">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-10-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-10-3" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-10-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-10-output-3.png" id="fig-10-3" class="img-fluid figure-img column-body" data-ref-parent="fig-10">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-10-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: ESM2 pseudo-perplexity scores for isomaltase sequences, colored by ML posterior probability bin. The x-axis shows the branch length to the root node of the tree, with the extant sequence on the far right (orange). The y-axis shows ESM2 pseudo-perplexity score.
</figcaption>
</figure>
</div>
</div>
<p>Isomaltase reveals similar but attenuated patterns compared to ADA1: pseudo-perplexity decreases among recent ancestors relative to extant sequences, though less pronounced than ADA1. This is followed by leveling off and slight increases for the oldest ancestors, again much less dramatic than the ADA1 pattern. These results confirm that ESM2’s preference for ancestral sequences over native sequences extends to this second gene family. However, we don’t observe the sharp increase in pseudo-perplexity seen with ADA1’s most ancient ancestors, likely because isomaltase lacks reconstructions with comparably low posterior probabilities or similar branch length divergence.</p>
<p>We also generated consensus ancestral sequences for isomaltase and compared their ESM2 pseudo-perplexity scores to maximum likelihood ancestral sequences.</p>
<div id="17ba8bae" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># generate isomaltase consensus ancestors</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>leaves_of_interest <span class="op">=</span> [</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A0A420MWB1_Fusarium_oxysporum"</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A0A177DQL5_Alternaria_alternata"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A0A4T0C5S8_Aureobasidium_pullulans"</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>ancestors_of_interest <span class="op">=</span> []</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry <span class="kw">in</span> leaves_of_interest:</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    ancestors_of_interest.extend(get_node_labels_leaf_to_root(iso_tree, entry))</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>ancestors_of_interest <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(ancestors_of_interest))</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>alignment_file <span class="op">=</span> <span class="st">"ASR/Isomaltase_ASR/outputs/isomaltase_dereplicated_final_recoded_mafft.fa"</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>name_conv_dict <span class="op">=</span> <span class="st">"ASR/Isomaltase_ASR/outputs/recoding_dict.txt"</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>gap_dict_json <span class="op">=</span> <span class="st">"ASR/Isomaltase_ASR/outputs/gap_positions.json"</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>consensus_seq_file <span class="op">=</span> <span class="st">"consensus_isomaltase_ancestors.fa"</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>records <span class="op">=</span> []</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry <span class="kw">in</span> ancestors_of_interest:</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    consensus_seq <span class="op">=</span> generate_node_consensus(</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        iso_tree, entry, alignment_file, name_conv_dict, gap_dict_json</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> entry <span class="op">+</span> <span class="st">"_consensus"</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    record <span class="op">=</span> SeqRecord(Seq(consensus_seq), <span class="bu">id</span><span class="op">=</span>name, description<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    records.append(record)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6eb7f242" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># retrieve esm2 scores for consensus seqs</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>consensus_file <span class="op">=</span> esm2_dir <span class="op">/</span> <span class="st">"consensus_isomaltase_ancestors_esm2_scores_650M.csv"</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>consensus_scores <span class="op">=</span> pd.read_csv(consensus_file)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>consensus_scores[<span class="st">"orig_id"</span>] <span class="op">=</span> consensus_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: x.replace(<span class="st">"_consensus"</span>, <span class="st">""</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>consensus_scores <span class="op">=</span> consensus_scores[[<span class="st">"orig_id"</span>, <span class="st">"sequence"</span>, <span class="st">"pseudo_perplexity"</span>]]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>consensus_scores <span class="op">=</span> consensus_scores.rename(</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sequence"</span>: <span class="st">"consensus_seq"</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pseudo_perplexity"</span>: <span class="st">"consensus_pppl"</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"orig_id"</span>: <span class="st">"sequence_id"</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co"># add new consensus seqs and scores to scores df</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>iso_scores <span class="op">=</span> iso_scores.merge(consensus_scores, how<span class="op">=</span><span class="st">"left"</span>, on<span class="op">=</span><span class="st">"sequence_id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>plot_evo_path_quiver(iso_scores, iso_tree, <span class="st">"A0A420MWB1_Fusarium_oxysporum"</span>, <span class="st">"lower right"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>plot_evo_path_quiver(iso_scores, iso_tree, <span class="st">"A0A177DQL5_Alternaria_alternata"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>plot_evo_path_quiver(iso_scores, iso_tree, <span class="st">"A0A4T0C5S8_Aureobasidium_pullulans"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-11" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="18">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-11-1" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-11-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-11-output-1.png" id="fig-11-1" class="img-fluid figure-img column-body" data-ref-parent="fig-11">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-11-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-11-2" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-11-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-11-output-2.png" id="fig-11-2" class="img-fluid figure-img column-body" data-ref-parent="fig-11">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-11-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-11-3" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-11-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-11-output-3.png" id="fig-11-3" class="img-fluid figure-img column-body" data-ref-parent="fig-11">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-11-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: ESM2 pseudo-perplexity (pppl) scores for consensus and maximum likelihood (ML) ancestors of ADA1, with arrows indicating which ancestor has the lower pseudo-perplexity score.
</figcaption>
</figure>
</div>
</div>
<p>This comparison shows distinct behavior from ADA1. In virtually all cases, pseudo-perplexity scores for maximum likelihood ancestors were lower than those for consensus ancestors. Overall, the model greatly prefers maximum likelihood ancestors for isomaltase, suggesting that the phylogenetic signal has been largely learned by the model rather than simple amino acid frequency distributions.</p>
<p>We also tested these sequences using different-sized ESM2 models to see if we observe differences between model sizes, as with ADA1. Below are the normalized scores.</p>
<div id="64aa3602" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load esm2 scores for isomaltase</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>iso_small_model_scores <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"isomaltase_all_esm2_scores_8M.csv"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>iso_med_model_scores <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"isomaltase_all_esm2_scores_35M.csv"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>iso_large_model_scores <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"isomaltase_all_esm2_scores_150M.csv"</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>iso_huge_model_scores <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"isomaltase_all_esm2_scores_3B.csv"</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>iso_small_model_scores[<span class="st">"ML prob"</span>] <span class="op">=</span> iso_small_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.mean([<span class="bu">max</span>(x) <span class="cf">for</span> x <span class="kw">in</span> iso_probs_dict[x]]) <span class="cf">if</span> x <span class="kw">in</span> iso_probs_dict <span class="cf">else</span> np.nan</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>iso_small_model_scores[<span class="st">"bl_to_root"</span>] <span class="op">=</span> iso_small_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: calc_branch_length_to_root_node(iso_tree, x[<span class="dv">4</span>:])</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x.startswith(<span class="st">"node"</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> calc_branch_length_to_root_leaf(iso_tree, x)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>iso_med_model_scores[<span class="st">"ML prob"</span>] <span class="op">=</span> iso_med_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.mean([<span class="bu">max</span>(x) <span class="cf">for</span> x <span class="kw">in</span> iso_probs_dict[x]]) <span class="cf">if</span> x <span class="kw">in</span> iso_probs_dict <span class="cf">else</span> np.nan</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>iso_med_model_scores[<span class="st">"bl_to_root"</span>] <span class="op">=</span> iso_med_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: calc_branch_length_to_root_node(iso_tree, x[<span class="dv">4</span>:])</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x.startswith(<span class="st">"node"</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> calc_branch_length_to_root_leaf(iso_tree, x)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>iso_large_model_scores[<span class="st">"ML prob"</span>] <span class="op">=</span> iso_large_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.mean([<span class="bu">max</span>(x) <span class="cf">for</span> x <span class="kw">in</span> iso_probs_dict[x]]) <span class="cf">if</span> x <span class="kw">in</span> iso_probs_dict <span class="cf">else</span> np.nan</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>iso_large_model_scores[<span class="st">"bl_to_root"</span>] <span class="op">=</span> iso_large_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: calc_branch_length_to_root_node(iso_tree, x[<span class="dv">4</span>:])</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x.startswith(<span class="st">"node"</span>)</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> calc_branch_length_to_root_leaf(iso_tree, x)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>iso_huge_model_scores[<span class="st">"ML prob"</span>] <span class="op">=</span> iso_huge_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.mean([<span class="bu">max</span>(x) <span class="cf">for</span> x <span class="kw">in</span> iso_probs_dict[x]]) <span class="cf">if</span> x <span class="kw">in</span> iso_probs_dict <span class="cf">else</span> np.nan</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>iso_huge_model_scores[<span class="st">"bl_to_root"</span>] <span class="op">=</span> iso_huge_model_scores[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: calc_branch_length_to_root_node(iso_tree, x[<span class="dv">4</span>:])</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x.startswith(<span class="st">"node"</span>)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> calc_branch_length_to_root_leaf(iso_tree, x)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell page-columns page-full" data-execution_count="20">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>plot_multiple_evo_lines(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>        (iso_small_model_scores, <span class="st">"A0A420MWB1_Fusarium_oxysporum"</span>, <span class="st">"8M"</span>),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        (iso_med_model_scores, <span class="st">"A0A420MWB1_Fusarium_oxysporum"</span>, <span class="st">"35M"</span>),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        (iso_large_model_scores, <span class="st">"A0A420MWB1_Fusarium_oxysporum"</span>, <span class="st">"150M"</span>),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        (iso_scores, <span class="st">"A0A420MWB1_Fusarium_oxysporum"</span>, <span class="st">"650M"</span>),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        (iso_huge_model_scores, <span class="st">"A0A420MWB1_Fusarium_oxysporum"</span>, <span class="st">"3B"</span>),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    iso_tree,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    normalize<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>plot_multiple_evo_lines(</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        (iso_small_model_scores, <span class="st">"A0A177DQL5_Alternaria_alternata"</span>, <span class="st">"8M"</span>),</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        (iso_med_model_scores, <span class="st">"A0A177DQL5_Alternaria_alternata"</span>, <span class="st">"35M"</span>),</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        (iso_large_model_scores, <span class="st">"A0A177DQL5_Alternaria_alternata"</span>, <span class="st">"150M"</span>),</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        (iso_scores, <span class="st">"A0A177DQL5_Alternaria_alternata"</span>, <span class="st">"650M"</span>),</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        (iso_huge_model_scores, <span class="st">"A0A177DQL5_Alternaria_alternata"</span>, <span class="st">"3B"</span>),</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    iso_tree,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    normalize<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>plot_multiple_evo_lines(</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>        (iso_small_model_scores, <span class="st">"A0A4T0C5S8_Aureobasidium_pullulans"</span>, <span class="st">"8M"</span>),</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>        (iso_med_model_scores, <span class="st">"A0A4T0C5S8_Aureobasidium_pullulans"</span>, <span class="st">"35M"</span>),</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>        (iso_large_model_scores, <span class="st">"A0A4T0C5S8_Aureobasidium_pullulans"</span>, <span class="st">"150M"</span>),</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>        (iso_scores, <span class="st">"A0A4T0C5S8_Aureobasidium_pullulans"</span>, <span class="st">"650M"</span>),</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>        (iso_huge_model_scores, <span class="st">"A0A4T0C5S8_Aureobasidium_pullulans"</span>, <span class="st">"3B"</span>),</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    iso_tree,</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    normalize<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-12" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="20">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-12-1" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-12-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-12-output-1.png" id="fig-12-1" class="img-fluid figure-img column-body" data-ref-parent="fig-12">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-12-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-12-2" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-12-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-12-output-2.png" id="fig-12-2" class="img-fluid figure-img column-body" data-ref-parent="fig-12">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-12-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display page-columns page-full">
<div id="fig-12-3" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-12-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="index_v1.0_files/figure-html/fig-12-output-3.png" id="fig-12-3" class="img-fluid figure-img column-body" data-ref-parent="fig-12">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-12-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Normalized ESM2 pseudo-perplexity vs distance to tree root for different ESM2 model sizes. For each species lineage, the pseudo-perplexity scores for each model are normalized to the score for the extant sequence for that model size.
</figcaption>
</figure>
</div>
</div>
<p>Here, we observe a similar phenomenon where the smallest models showed largely consistent pseudo-perplexity scores. In contrast, the largest models showed more pronounced increases in pseudo-perplexity than the oldest ancestors. This pattern was consistent with ADA1 observations but less dramatic. Nonetheless, this observation is consistent with the idea that selection of ESM2 model size is essential in interpreting the plausibility of ancestral sequences relative to native.</p>
</section>
<section id="relationship-between-asr-confidence-and-esm2-pseudo-perplexity" class="level2">
<h2 class="anchored" data-anchor-id="relationship-between-asr-confidence-and-esm2-pseudo-perplexity">Relationship between ASR confidence and ESM2 pseudo-perplexity</h2>
<p>The isomaltase results prompted us to investigate whether a general relationship exists between maximum likelihood ancestral reconstruction posterior probabilities and ESM2 pseudo-perplexity. We pooled results from both ADA1 and isomaltase phylogenies and calculated pseudo-perplexity scores for all native and ancestral sequences using the 650M-parameter model.</p>
<div id="f7e5fae8" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pull data for all remaining ADA1 sequences</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>remaining_df <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"ADA1_remaining_esm2_scores_650M.csv"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>remaining_df <span class="op">=</span> remaining_df[[<span class="st">"sequence_id"</span>, <span class="st">"sequence"</span>, <span class="st">"pseudo_perplexity"</span>]]</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># combine with original scores</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>all_scores <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"ADA1_all_esm2_scores_650M.csv"</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>all_scores <span class="op">=</span> all_scores[[<span class="st">"sequence_id"</span>, <span class="st">"sequence"</span>, <span class="st">"pseudo_perplexity"</span>]]</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>full_data <span class="op">=</span> pd.concat([remaining_df, all_scores])</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Add in ML posterior probabilities from ASR run</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>ml_probs_json <span class="op">=</span> <span class="st">"ASR/ADA1_ASR/outputs/posterior_probabilities_no_gaps.json"</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>ml_probs_json <span class="op">=</span> Path(ml_probs_json)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(ml_probs_json) <span class="im">as</span> f:</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    probs_dict <span class="op">=</span> json.load(f)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>full_data[<span class="st">"ML prob"</span>] <span class="op">=</span> full_data[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.mean([<span class="bu">max</span>(x) <span class="cf">for</span> x <span class="kw">in</span> probs_dict[x]]) <span class="cf">if</span> x <span class="kw">in</span> probs_dict <span class="cf">else</span> np.nan</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>full_data[<span class="st">"ML prob"</span>] <span class="op">=</span> full_data[<span class="st">"ML prob"</span>].fillna(<span class="fl">1.1</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="co"># pull data for all iso native and ancestor</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>remaining_df <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"isomaltase_remaining_esm2_scores_650M.csv"</span>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>remaining_df <span class="op">=</span> remaining_df[[<span class="st">"sequence_id"</span>, <span class="st">"sequence"</span>, <span class="st">"pseudo_perplexity"</span>]]</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="co"># combine with original scores</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>iso_scores <span class="op">=</span> pd.read_csv(esm2_dir <span class="op">/</span> <span class="st">"isomaltase_all_esm2_scores_650M.csv"</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>iso_scores <span class="op">=</span> iso_scores[[<span class="st">"sequence_id"</span>, <span class="st">"sequence"</span>, <span class="st">"pseudo_perplexity"</span>]]</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>full_data_iso <span class="op">=</span> pd.concat([remaining_df, iso_scores])</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve ML posterior probabilities from ASR run</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>ml_probs_json <span class="op">=</span> <span class="st">"ASR/Isomaltase_ASR/outputs/posterior_probabilities_no_gaps.json"</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>ml_probs_json <span class="op">=</span> Path(ml_probs_json)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(ml_probs_json) <span class="im">as</span> f:</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    probs_dict_iso <span class="op">=</span> json.load(f)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>full_data_iso[<span class="st">"ML prob"</span>] <span class="op">=</span> full_data_iso[<span class="st">"sequence_id"</span>].<span class="bu">apply</span>(</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.mean([<span class="bu">max</span>(x) <span class="cf">for</span> x <span class="kw">in</span> probs_dict_iso[x]]) <span class="cf">if</span> x <span class="kw">in</span> probs_dict_iso <span class="cf">else</span> np.nan</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>full_data_iso[<span class="st">"ML prob"</span>] <span class="op">=</span> full_data_iso[<span class="st">"ML prob"</span>].fillna(<span class="fl">1.1</span>)</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a><span class="co"># merge all data together</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>full_data_both <span class="op">=</span> pd.concat([full_data, full_data_iso])</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>full_data_both <span class="op">=</span> full_data_both.drop_duplicates()</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="co"># print sizes of each</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total ADA1 sequences: </span><span class="sc">{</span><span class="bu">len</span>(full_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Isomaltase sequences: </span><span class="sc">{</span><span class="bu">len</span>(full_data_iso)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total ADA1 sequences: 461
Total Isomaltase sequences: 571</code></pre>
</div>
</div>
<p>We can then view the relationship between ML posterior probability and ESM2 pseudo-perplexity for all these sequences.</p>
<div id="cell-fig-13" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.analysis.data_processing <span class="im">import</span> violin_plot</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>bins <span class="op">=</span> [<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.85</span>, <span class="fl">0.9</span>, <span class="fl">0.95</span>, <span class="fl">1.0</span>, <span class="fl">1.1</span>]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>bin_labels <span class="op">=</span> [<span class="st">"&lt; 0.8"</span>, <span class="st">"0.80-0.85"</span>, <span class="st">"0.85-0.90"</span>, <span class="st">"0.90-0.95"</span>, <span class="st">"0.95-1.00"</span>, <span class="st">"Extant"</span>]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>violin_plot(full_data_both, bins, bin_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-13" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_v1.0_files/figure-html/fig-13-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Violin plot of ESM2 pseudo-perplexity scores for both ADA1 and isomaltase sequences, binned by ML posterior probability. Horizontal bar indicates median score in each bin and number of samples in each bin indicated above.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Here we do observe a broad pattern. We see the highest median pseudo-perplexity for extant sequences. Values decrease in the 0.95-1.0 and 0.90-0.95 posterior probability bins, level off in the 0.85-0.9 bins, and begin increasing again as probabilities drop below 0.85.</p>
<p>To test the significance of these differences, we performed a Kruskal–Wallis and Dunn-Bonferroni post-hoc test.</p>
<div id="bf2c3dc1" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.analysis.data_processing <span class="im">import</span> kruskal_wallis_with_significant_posthoc</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform Kruskal-Wallis test and Dunn-Benforroni and print significant comparisons</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>kruskal_wallis_with_significant_posthoc(full_data_both, bins, bin_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Kruskal-Wallis test result: H = 191.825, p = 1.591e-39

Significant Dunn post hoc comparisons (adjusted p &lt; 0.05):
Group 1      Group 2      Adj. p-value
--------------------------------------
&lt; 0.8        0.85-0.90    4.420e-04   
&lt; 0.8        0.90-0.95    5.322e-06   
&lt; 0.8        0.95-1.00    4.800e-04   
0.85-0.90    Extant       4.610e-06   
0.90-0.95    Extant       5.500e-14   
0.95-1.00    Extant       3.694e-31   </code></pre>
</div>
</div>
<p>These analyses indicate a significant effect of ML posterior probability bin on pseudo-perplexity (p &lt;&lt; 0.001). Post hoc tests revealed that both extant sequences and the lowest-confidence ancestral reconstructions (&lt; 0.8) exhibit significantly higher pseudo-perplexity than the high-confidence reconstructed bins. Differences among the intermediate confidence bins themselves weren’t statistically significant.</p>
<p>While broader generalization will require analyzing more genes, these results support the idea that ancestral sequences tend to show lower pseudo-perplexity than extant sequences, up to a point. Once mean posterior probabilities drop below ~0.85, pseudo-perplexity increases, suggesting the model becomes less confident in these reconstructed sequences (for the 650M-parameter ESM2 model).</p>
</section>
<section id="discussion-and-conclusions" class="level2">
<h2 class="anchored" data-anchor-id="discussion-and-conclusions">Discussion and conclusions</h2>
<p>Our analysis suggests that ESM2 models, particularly at larger scales, capture some aspects of evolutionary signal in a context-dependent and inconsistent manner. While it’s difficult to distinguish true phylogenetic understanding from overfitting to training sequences, we observe several intriguing patterns:</p>
<p><strong>Lower pseudo-perplexity for ancestral sequences</strong>.</p>
<p>Across both gene families and species, ESM2 often assigns lower pseudo-perplexity scores to reconstructed ancestral sequences than to extant descendants. This pattern is especially pronounced for high-confidence reconstructions, even though these ancestral sequences weren’t in the training data. This behavior has been previously observed for other protein families (<span class="citation" data-cites="kantroo_pseudo-perplexity_2024">Kantroo et al. (<a href="#ref-kantroo_pseudo-perplexity_2024" role="doc-biblioref">2024</a>)</span>)</p>
<p><strong>Discrimination between ML and consensus ancestors</strong>.</p>
<p>In cases where reconstructions are well-supported, ESM2 prefers maximum likelihood ancestors over simple consensus sequences, suggesting sensitivity to subtle features of evolutionary plausibility beyond mere amino acid frequency. However, this preference weakens for ancient or low-confidence ancestors, likely reflecting poor reconstruction quality or increasing divergence from the training set distribution.</p>
<p><strong>Model size affects evolutionary patterns</strong>.</p>
<p>While larger ESM2 models (650M and 3B parameters) show more nuanced relationships between reconstruction confidence and evolutionary age, smaller models show flatter distributions, indicating reduced sensitivity. This suggests that some of this ability to interpret evolutionary relationships may emerge only in larger models.</p>
<p>While these findings are limited to two gene families and a specific ASR approach, they support that ESM2’s treatment of ancestral sequences isn’t random and may reflect partial capture of phylogenetic information. Still, the patchiness of the observed patterns cautions against strong claims. Further investigation is needed to determine whether large protein language models like ESM2 genuinely encode evolutionary relationships, and orthogonal approaches may be needed to more deeply interrogate this idea. (<span class="citation" data-cites="ektefaie_sequence_2025">Ektefaie et al. (<a href="#ref-ektefaie_sequence_2025" role="doc-biblioref">2025</a>)</span>)</p>
</section>
<section id="references" class="level2">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-avasthi_proteincartography_2023" class="csl-entry" role="listitem">
Avasthi P, Bigge BM, Borges AL, Celebi FM, Cheveralls K, Dutton RJ, Gehring J, Hochstrasser ML, Iii GG, MacQuarrie CD, Matus DQ, McDaniel EA, McGeever E, Mishne G, Morin M, Radkov A, Reiter T, Reitman ME, Sun DA, Weiss ECP. (2023). <span>ProteinCartography</span>: <span>Comparing</span> proteins with structure-based maps for interactive exploration. <a href="https://doi.org/10.57844/arcadia-a5a6-1068">https://doi.org/10.57844/arcadia-a5a6-1068</a>
</div>
<div id="ref-bhatnagar_scaling_2025" class="csl-entry" role="listitem">
Bhatnagar A, Jain S, Beazer J, Curran SC, Hoffnagle AM, Ching K, Martyn M, Nayfach S, Ruffolo JA, Madani A. (2025). Scaling unlocks broader generation and deeper functional understanding of proteins. <a href="https://doi.org/10.1101/2025.04.15.649055">https://doi.org/10.1101/2025.04.15.649055</a>
</div>
<div id="ref-bridgham2006" class="csl-entry" role="listitem">
Bridgham JT, Carroll SM, Thornton JW. (2006). Evolution of hormone-receptor complexity by molecular exploitation. <a href="https://doi.org/10.1126/science.1123348">https://doi.org/10.1126/science.1123348</a>
</div>
<div id="ref-ektefaie_sequence_2025" class="csl-entry" role="listitem">
Ektefaie Y, Shen A, Jain L, Farhat M, Zitnik M. (2025). Sequence <span>Modeling</span> <span>Is</span> <span>Not</span> <span>Evolutionary</span> <span>Reasoning</span>. <a href="https://doi.org/10.1101/2025.01.17.633626">https://doi.org/10.1101/2025.01.17.633626</a>
</div>
<div id="ref-hayes_simulating_2025" class="csl-entry" role="listitem">
Hayes T, Rao R, Akin H, Sofroniew NJ, Oktay D, Lin Z, Verkuil R, Tran VQ, Deaton J, Wiggert M, Badkundri R, Shafkat I, Gong J, Derry A, Molina RS, Thomas N, Khan YA, Mishra C, Kim C, Bartie LJ, Nemeth M, Hsu PD, Sercu T, Candido S, Rives A. (2025). Simulating 500 million years of evolution with a language model. <a href="https://doi.org/10.1126/science.ads0018">https://doi.org/10.1126/science.ads0018</a>
</div>
<div id="ref-hochberg_reconstructing_2017" class="csl-entry" role="listitem">
Hochberg GKA, Thornton JW. (2017). Reconstructing <span>Ancient</span> <span>Proteins</span> to <span>Understand</span> the <span>Causes</span> of <span>Structure</span> and <span>Function</span>. <a href="https://doi.org/10.1146/annurev-biophys-070816-033631">https://doi.org/10.1146/annurev-biophys-070816-033631</a>
</div>
<div id="ref-ishikawa_fast_2019" class="csl-entry" role="listitem">
Ishikawa SA, Zhukova A, Iwasaki W, Gascuel O. (2019). A <span>Fast</span> <span>Likelihood</span> <span>Method</span> to <span>Reconstruct</span> and <span>Visualize</span> <span>Ancestral</span> <span>Scenarios</span>. <a href="https://doi.org/10.1093/molbev/msz131">https://doi.org/10.1093/molbev/msz131</a>
</div>
<div id="ref-kantroo_pseudo-perplexity_2024" class="csl-entry" role="listitem">
Kantroo P, Wagner GP, Machta BB. (2024). Pseudo-perplexity in <span>One</span> <span>Fell</span> <span>Swoop</span> for <span>Protein</span> <span>Fitness</span> <span>Estimation</span>. <a href="https://doi.org/10.48550/arXiv.2407.07265">https://doi.org/10.48550/arXiv.2407.07265</a>
</div>
<div id="ref-katoh_mafft_2002" class="csl-entry" role="listitem">
Katoh K, Misawa K, Kuma K, Miyata T. (2002). <span>MAFFT</span>: A novel method for rapid multiple sequence alignment based on fast <span>Fourier</span> transform. <a href="https://doi.org/10.1093/nar/gkf436">https://doi.org/10.1093/nar/gkf436</a>
</div>
<div id="ref-lin_evolutionary-scale_2023" class="csl-entry" role="listitem">
Lin Z, Akin H, Rao R, Hie B, Zhu Z, Lu W, Smetanin N, Verkuil R, Kabeli O, Shmueli Y, Santos Costa A dos, Fazel-Zarandi M, Sercu T, Candido S, Rives A. (2023). Evolutionary-scale prediction of atomic-level protein structure with a language model. <a href="https://doi.org/10.1126/science.ade2574">https://doi.org/10.1126/science.ade2574</a>
</div>
<div id="ref-lupo_protein_2022" class="csl-entry" role="listitem">
Lupo U, Sgarbossa D, Bitbol A-F. (2022). Protein language models trained on multiple sequence alignments learn phylogenetic relationships. <a href="https://doi.org/10.1038/s41467-022-34032-y">https://doi.org/10.1038/s41467-022-34032-y</a>
</div>
<div id="ref-nguyen_iq-tree_2015" class="csl-entry" role="listitem">
Nguyen L-T, Schmidt HA, Haeseler A von, Minh BQ. (2015). <span>IQ</span>-<span>TREE</span>: <span>A</span> <span>Fast</span> and <span>Effective</span> <span>Stochastic</span> <span>Algorithm</span> for <span>Estimating</span> <span>Maximum</span>-<span>Likelihood</span> <span>Phylogenies</span>. <a href="https://doi.org/10.1093/molbev/msu300">https://doi.org/10.1093/molbev/msu300</a>
</div>
<div id="ref-orlandi_topiary_2023" class="csl-entry" role="listitem">
Orlandi KN, Phillips SR, Sailer ZR, Harman JL, Harms MJ. (2023). Topiary: <span>Pruning</span> the manual labor from ancestral sequence reconstruction. <a href="https://doi.org/10.1002/pro.4551">https://doi.org/10.1002/pro.4551</a>
</div>
<div id="ref-salazar_masked_2020" class="csl-entry" role="listitem">
Salazar J, Liang D, Nguyen TQ, Kirchhoff K. (2020). Masked <span>Language</span> <span>Model</span> <span>Scoring</span>. <a href="https://doi.org/10.18653/v1/2020.acl-main.240">https://doi.org/10.18653/v1/2020.acl-main.240</a>
</div>
<div id="ref-tule_protein_2025" class="csl-entry" role="listitem">
Tule S, Foley G, Bodén M. (2025). Do protein language models learn phylogeny? <a href="https://doi.org/10.1093/bib/bbaf047">https://doi.org/10.1093/bib/bbaf047</a>
</div>
<div id="ref-voordeckers_reconstruction_2012" class="csl-entry" role="listitem">
Voordeckers K, Brown CA, Vanneste K, Zande E van der, Voet A, Maere S, Verstrepen KJ. (2012). Reconstruction of <span>Ancestral</span> <span>Metabolic</span> <span>Enzymes</span> <span>Reveals</span> <span>Molecular</span> <span>Mechanisms</span> <span>Underlying</span> <span>Evolutionary</span> <span>Innovation</span> through <span>Gene</span> <span>Duplication</span>. <a href="https://doi.org/10.1371/journal.pbio.1001446">https://doi.org/10.1371/journal.pbio.1001446</a>
</div>
<div id="ref-wilson_using_2015" class="csl-entry" role="listitem">
Wilson C, Agafonov RV, Hoemberger M, Kutter S, Zorba A, Halpin J, Buosi V, Otten R, Waterman D, Theobald DL, Kern D. (2015). Using ancient protein kinases to unravel a modern cancer drug’s mechanism. <a href="https://doi.org/10.1126/science.aaa1823">https://doi.org/10.1126/science.aaa1823</a>
</div>
<div id="ref-yang_paml_2007" class="csl-entry" role="listitem">
Yang Z. (2007). <span>PAML</span> 4: <span>Phylogenetic</span> <span>Analysis</span> by <span>Maximum</span> <span>Likelihood</span>. <a href="https://doi.org/10.1093/molbev/msm088">https://doi.org/10.1093/molbev/msm088</a>
</div>
<div id="ref-york_phylogenies_2025" class="csl-entry" role="listitem">
York R, Bell A, Avasthi P, McGeever E. (2025). Phylogenies and biological foundation models. <a href="https://doi.org/10.57844/arcadia-znum-bm22">https://doi.org/10.57844/arcadia-znum-bm22</a>
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/Arcadia-Science\.github\.io\/2025-asr-plms\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "Arcadia-Science/2025-asr-plms";
    script.dataset.repoId = "R_kgDOOncD9w";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOOncD984Ctjdm";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://www.arcadiascience.com/"><img src="./assets/logo_white.png" class="img-fluid" alt="Arcadia-Science" width="65"></a> Copyright 2025, Arcadia Science</p>
</div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/arcadiascience">
      <i class="bi bi-twitter-x" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Arcadia-Science">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>