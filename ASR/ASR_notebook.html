<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Recode deflines to 10 character max</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../assets/logo_white.png" rel="icon" type="image/png">
<script src="../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-2e258beaaab509f8ad3e40bd486fc5fc.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-08905YE5NE"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-08905YE5NE', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<!-- logo-animation.html -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const brandLink = document.querySelector(".navbar-brand");
    const logoImg = brandLink.querySelector("img.navbar-logo");
    const video = document.createElement("video");
    video.classList.add("navbar-logo", "video-logo");
    video.autoplay = true;
    video.muted = true;
    video.playsInline = true;
    video.loop = false;
    video.playbackRate = 1.0;

    const source = document.createElement("source");
    // Github Pages sites are served from a path like `https://arcadia-science.github.io/<repo>/`
    // so we need to add the repo name to the path when we're on Github Pages.
    const siteRoot = (window.location.hostname.endsWith('github.io')) ? `/${window.location.pathname.split('/')[1]}` : '';
    source.src = `${siteRoot}/assets/logo_movie.mp4`;
    source.type = "video/mp4";
    video.appendChild(source);

    // Function to handle video playback
    function handleVideoPlayback() {
      if (video.ended || video.paused) {
        video.currentTime = 0;
        video.playbackRate = 3.0;
        video.play().catch(e => console.log("Playback failed:", e));
      }
    }

    // Add hover event listener
    brandLink.addEventListener("mouseenter", handleVideoPlayback);

    // Handle visibility changes
    document.addEventListener("visibilitychange", function () {
      if (document.visibilityState === "visible") {
        handleVideoPlayback();
      }
    });

    // Handle page show (useful for mobile back button / screen unlock)
    window.addEventListener("pageshow", function (event) {
      if (event.persisted) {
        handleVideoPlayback();
      }
    });

    video.addEventListener("error", function () {
      console.error("Video playback error");
      logoImg.style.visibility = "visible";
      video.remove();
    });

    brandLink.appendChild(video);
  });
</script>
<template id="authors-template">
  <div class="authors-section">
    <button class="authors-toggle">
      <span class="authors-toggle-text">Show authors</span>
      <i class="bi bi-chevron-down authors-toggle-icon"></i>
    </button>
    <div class="authors-content quarto-title-meta-contents">
      <span class="author-order-indicator">(sorted A-Z)</span>
    </div>
  </div>
</template>

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
<script>
  initAuthorReveal();

  function initAuthorReveal() {
    require.config({
      paths: {
        'js-yaml': 'https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min'
      }
    });

    require(['js-yaml'], function (jsyaml) {
      // Function to get last name from full name
      function getLastName(fullName) {
        const nameParts = fullName.trim().split(' ');
        return nameParts[nameParts.length - 1];
      }

      // Function to load the YAML file
      async function loadAuthorData() {
        try {
          // Github Pages sites are served from a path like `https://arcadia-science.github.io/<repo>/`
          // so we need to add the repo name to the path when we're on Github Pages.
          const siteRoot = (window.location.hostname.endsWith('github.io')) ? `/${window.location.pathname.split('/')[1]}` : '';
          const authorYamlPath = `${siteRoot}/authors.yml`;
          const response = await fetch(authorYamlPath);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const yamlText = await response.text();
          window.authorData = jsyaml.load(yamlText);
          initializeAuthors();
        } catch (error) {
          console.error('Error loading author data:', error);
        }
      }

      function initializeAuthors() {
        // Find the quarto-title-meta div
        const titleMeta = document.querySelector('.quarto-title-meta');
        if (!titleMeta) {
          return;
        }

        // Get template content
        const template = document.getElementById('authors-template');
        if (!template) {
          return;
        }
        const authorsSection = template.content.cloneNode(true);

        // Get the authors content div from the cloned template
        const authorsContent = authorsSection.querySelector('.authors-content');

        // Update sort to use last name
        const sortedAuthors = [...authorData.authors].sort((a, b) => {
          const lastNameA = getLastName(a.name);
          const lastNameB = getLastName(b.name);
          return lastNameA.localeCompare(lastNameB);
        });

        // Process authors from the data
        sortedAuthors.forEach(author => {
          const authorP = document.createElement('p');

          // Create name span
          const nameSpan = document.createElement('span');
          nameSpan.className = 'author-name';
          nameSpan.textContent = author.name;
          authorP.appendChild(nameSpan);

          // Add ORCID if present
          if (author.orcid) {
            const orcidLink = document.createElement('a');
            orcidLink.href = `https://orcid.org/${author.orcid}`;
            orcidLink.className = 'quarto-title-author-orcid';

            const orcidImage = document.createElement('img');
            orcidImage.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==';
            orcidLink.appendChild(orcidImage);

            authorP.appendChild(orcidLink);
          }

          // Add to authors content
          authorsContent.appendChild(authorP);

          // Add tippy tooltip with roles if present
          if (author.roles) {
            const tooltipContent = `Roles: ${author.roles.map(r => r.charAt(0).toUpperCase() + r.slice(1)).join(', ')}`;
            tippy(nameSpan, {
              content: tooltipContent,
              allowHTML: true,
              placement: 'bottom',
              arrow: true,
              theme: 'custom'
            });
          }
        });

        // Create container and insert at the beginning of title meta
        const containerDiv = document.createElement('div');
        titleMeta.insertBefore(containerDiv, titleMeta.firstChild);
        containerDiv.appendChild(authorsSection);

        // Add toggle functionality
        const toggle = document.querySelector('.authors-toggle');
        const content = document.querySelector('.authors-content');

        if (!toggle || !content) {
          return;
        }

        toggle.addEventListener('click', () => {
          const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
          toggle.setAttribute('aria-expanded', !isExpanded);
          content.classList.toggle('is-visible');
        });

        // Initialize ARIA attributes
        toggle.setAttribute('aria-expanded', 'false');
        toggle.setAttribute('aria-controls', 'authors-content');
        content.setAttribute('id', 'authors-content');
      }

      // Start loading when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadAuthorData);
      } else {
        loadAuthorData();
      }
    });
  }
</script>
<template id="mini-title-template">
  <div class="mini-title page-columns page-full">
    <div class="mini-title-content">
      <div class="mini-title-logo-wrapper">
        <a href="https://research.arcadiascience.com/">
          <img class="logo-white" src="/assets/logo_white.png" alt="Logo">
        </a>
      </div>
      <p></p>
      <div id="mini-version-control"></div>
    </div>
  </div>
</template>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Get required elements
    const template = document.getElementById('mini-title-template');
    const titleBanner = document.querySelector('.quarto-title-banner');
    const abstract = document.querySelector('.abstract');
    const navbar = document.querySelector('#quarto-header');

    // Github Pages sites are served from a path like `https://arcadia-science.github.io/<repo>/`
    // so we need to add the repo name to the path when we're on Github Pages.
    const siteRoot = (window.location.hostname.endsWith('github.io')) ? `/${window.location.pathname.split('/')[1]}` : '';
    template.content.querySelector('.logo-white').src = `${siteRoot}/assets/logo_white.png`;

    let prevRatio = {appear: 1, disappear: 1};

    if (template && titleBanner && abstract && navbar) {
      // Add the mini title to the document body
      const miniTitleContent = document.importNode(template.content, true);
      document.body.appendChild(miniTitleContent);

      // Get and set the title text from h1.title
      const titleElement = document.querySelector('h1.title');
      const miniTitleP = document.querySelector('.mini-title-content p');
      if (titleElement && miniTitleP) {
        const titleText = titleElement.childNodes[0].textContent.trim();
        miniTitleP.textContent = titleText;

        // Only clone and add version control if title is not the demo title
        if (titleText !== 'A brief syntax demo') {
          // Clone version control dropdown if it exists
          const originalDropdown = document.querySelector('.navbar-nav .nav-item.dropdown:has(iconify-icon[icon="qlementine-icons:version-control-16"])');
          if (originalDropdown) {
            const clonedDropdown = originalDropdown.cloneNode(true);
            // Remove menu-text class but keep contents
            const menuTextSpan = clonedDropdown.querySelector('.menu-text');
            if (menuTextSpan) {
              menuTextSpan.classList.remove('menu-text');
            }
            // Add to mini version control container
            const versionContainer = document.querySelector('#mini-version-control');
            versionContainer.appendChild(clonedDropdown);
            // Initialize Bootstrap dropdown
            if (typeof bootstrap !== 'undefined') {
              const dropdownElement = clonedDropdown.querySelector('.dropdown-toggle');
              if (dropdownElement) {
                new bootstrap.Dropdown(dropdownElement);
              }
            }
          }
        }
      }

      const stickyMiniTitle = document.querySelector('.mini-title');

      // Navbar state management
      function updateNavbarState() {
        const isNavbarPinned = navbar.classList.contains('headroom--pinned');
        const isNavbarTop = !navbar.classList.contains('headroom--not-top');

        if (isNavbarPinned || isNavbarTop) {
          document.body.classList.add('navbar-visible');
        } else {
          document.body.classList.remove('navbar-visible');
        }
      }

      // Observe navbar class changes
      const navbarObserver = new MutationObserver(updateNavbarState);
      navbarObserver.observe(navbar, {
        attributes: true,
        attributeFilter: ['class']
      });
      updateNavbarState(); // Initial state

      // Mini title visibility functions
      function toggleMiniTitle(show) {
        document.body.classList.toggle('mini-title-visible', show);
        stickyMiniTitle.classList.toggle('visible', show);
      }

      // Create intersection observer with configurable options
      function createIntersectionObserver(type, rootMargin) {
        return new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            const currentRatio = entry.intersectionRatio;

            if (prevRatio[type] === 0 && currentRatio > 0) {
              toggleMiniTitle(false);
            } else if (prevRatio[type] > 0 && currentRatio === 0) {
              toggleMiniTitle(true);
            }

            prevRatio[type] = currentRatio;
          });
        }, {
          threshold: [0, 0.1],
          rootMargin
        });
      }

      // Create observers with different root margins
      const appearObserver = createIntersectionObserver('appear', '-48px');
      const disappearObserver = createIntersectionObserver('disappear', '48px');

      // Start observing title banner with both observers
      appearObserver.observe(titleBanner);
      disappearObserver.observe(titleBanner);

      // Cleanup
      window.addEventListener('beforeunload', () => {
        navbarObserver.disconnect();
        appearObserver.disconnect();
        disappearObserver.disconnect();
      });
    }
  });
</script>
<!-- version-in-title.html -->
<meta property="og:title" content="Recode deflines to 10 character max">
<meta name="twitter:title" content="Recode deflines to 10 character max">
<meta name="twitter:card" content="summary">
</head><body class="nav-fixed quarto-light"><div id="title-version-control"></div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Find the original version control dropdown
    const originalDropdown = document.querySelector('.navbar-nav .nav-item.dropdown:has(iconify-icon[icon="qlementine-icons:version-control-16"])');
    if (originalDropdown && document.querySelector('.quarto-title')) {
      // Clone the dropdown structure
      const clonedDropdown = originalDropdown.cloneNode(true);
      // Update classes
      clonedDropdown.className = 'title-version-menu dropdown';
      // Remove the menu-text class but keep the span and its contents
      const menuTextSpan = clonedDropdown.querySelector('.menu-text');
      if (menuTextSpan) {
        menuTextSpan.classList.remove('menu-text');
      }
      // Find the title element
      const titleElement = document.querySelector('.quarto-title .title');
      if (titleElement) {
        // Add the version control to the container
        const versionContainer = document.getElementById('title-version-control');
        versionContainer.appendChild(clonedDropdown);
        titleElement.appendChild(versionContainer);

        // Check if this is the author guide and hide if it is
        if (titleElement.childNodes[0].textContent.trim() === 'A brief syntax demo') {
          versionContainer.style.display = 'none';
          versionContainer.style.visibility = 'hidden';
          versionContainer.style.pointerEvents = 'none';
        }

        // Ensure Bootstrap dropdown functionality works on the clone
        if (typeof bootstrap !== 'undefined') {
          const dropdownElement = clonedDropdown.querySelector('.dropdown-toggle');
          if (dropdownElement) {
            new bootstrap.Dropdown(dropdownElement);
          }
        }
      }
    }
  });
</script>
<!-- TODO: This solution currently generates the bibtex on the fly using a regex pattern. Ideally, the bibtex is a static file in the repository, similar to CITATION.cff. -->
<template id="citation-box-template">
  <div id="citation-popup" class="citation-popup">
    <div class="citation-popup-content">
      <div class="citation-header">
        <h4>Cite this pub</h4>
        <button id="close-citation-box" class="close-button" aria-label="Close citation box">×</button>
      </div>
      <div class="citation-tabs">
        <button class="citation-tab-button active" data-format="styled">Arcadia</button>
        <button class="citation-tab-button" data-format="bibtex">BibTeX</button>
      </div>
      <div class="citation-body">
        <div id="styled-citation" class="citation-content active">
          <p class="loading-text">Loading citation...</p>
        </div>
        <div id="bibtex-citation" class="citation-content">
          <pre class="loading-text">Loading citation...</pre>
        </div>
      </div>
      <div class="citation-footer">
        <button id="copy-citation-button" class="copy-button">
          <i class="bi bi-clipboard"></i> Copy to clipboard
        </button>
      </div>
    </div>
  </div>
</template>

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
<script>
  // Initialize citation functionality after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCitationBox);
  } else {
    initCitationBox();
  }

  function initCitationBox() {
    require.config({
      paths: {
        'js-yaml': 'https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min'
      }
    });

    require(['js-yaml'], function (jsyaml) {

      // Add citation box template to the document
      const template = document.getElementById('citation-box-template');
      const citationBoxContent = document.importNode(template.content, true);
      document.body.appendChild(citationBoxContent);

      // Find citation button
      const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
      let citeButton = null;
      for (const link of navLinks) {
        if (link.textContent && link.textContent.trim() === 'Cite this pub') {
          citeButton = link;
          break;
        }
      }

      // Reference elements (assuming they exist in the template)
      const citationPopup = document.getElementById('citation-popup');
      const closeButton = document.getElementById('close-citation-box');
      const copyButton = document.getElementById('copy-citation-button');
      const tabButtons = document.querySelectorAll('.citation-tab-button');
      const styledEl = document.getElementById('styled-citation');
      const bibtexEl = document.getElementById('bibtex-citation');

      let pubData = {};
      let isDataLoaded = false;

      // --- Function to load the citation data ---
      async function loadCitationData() {
        // Set loading text (will be replaced on success)
        styledEl.innerHTML = `<p class="loading-text">Loading citation...</p>`;
        bibtexEl.innerHTML = `<pre class="loading-text">Loading citation...</pre>`;

        // Fetch and parse CFF
        const siteRoot = (window.location.hostname.endsWith('github.io')) ? `/${window.location.pathname.split('/')[1]}` : '';
        const citationCffPath = `${siteRoot}/CITATION.cff`;
        const response = await fetch(citationCffPath);
        const text = await response.text();
        const cffData = jsyaml.load(text);

        const preferredCitation = cffData['preferred-citation'];
        const title = preferredCitation.title;
        const year = preferredCitation.year;
        const doi = preferredCitation.doi;
        const authors = preferredCitation.authors;

        pubData = {
          title: String(title).trim(),
          year: String(year).trim(),
          doi: String(doi).trim(),
          authors: []
        };

        for (const author of authors) {
          pubData.authors.push({
            family: String(author['family-names']).trim(),
            given: String(author['given-names']).trim()
          });
        }

        updateCitations();
        isDataLoaded = true;
      }

      function updateCitations() {
        const url = pubData.doi ? `https://doi.org/${pubData.doi}` : window.location.href;

        // Text citation
        const styledAuthors = pubData.authors.map(author => {
          const initials = author.given.split(/\s+/).map(name => name.charAt(0)).join('');
          return `${author.family} ${initials}`;
        }).join(', ');
        styledEl.innerHTML = `<p>${styledAuthors}. (${pubData.year}). ${pubData.title}. ${url}</p>`;

        // BibTeX citation
        const firstAuthor = pubData.authors[0]; // Assume at least one author
        const bibtexKey = `${firstAuthor.family.replace(/[^a-zA-Z0-9]/g, '')}${pubData.year}${pubData.title.split(' ')[0].replace(/[^a-zA-Z0-9]/g, '')}`;
        const escapedTitle = pubData.title.replace(/([{}])/g, '\\$1');
        const titleWithCaps = escapedTitle.replace(/\b([A-Z][a-zA-Z0-9'-]*)\b/g, '{$1}');
        const bibtexAuthors = pubData.authors.map(author => `${author.family}, ${author.given}`).join(' and ');

        const bibtexContentFinal = `@article{${bibtexKey},
    author = {${bibtexAuthors}},
    title = {${titleWithCaps}},
    journal = {Arcadia Science},
    year = {${pubData.year}},${pubData.doi ? `\n    doi = {${pubData.doi}},` : ''}
    url = {${url}}
}`;
        bibtexEl.innerHTML = `<pre>${bibtexContentFinal}</pre>`;
      }

      // --- Function to toggle the citation box ---
      function toggleCitationBox() {
        const isVisible = citationPopup.classList.contains('visible');
        if (!isVisible) {
          citationPopup.classList.add('visible');
          // Load data only once on first open
          if (!isDataLoaded) {
            loadCitationData(); // Assuming this will succeed
          }
        } else {
          citationPopup.classList.remove('visible');
        }
      }

      // --- Event listeners ---
      citeButton.addEventListener('click', function (e) {
        e.preventDefault();
        toggleCitationBox();
      });

      closeButton.addEventListener('click', function () {
        citationPopup.classList.remove('visible');
      });

      // Tab switching
      tabButtons.forEach(button => {
        button.addEventListener('click', function () {
          tabButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.citation-content').forEach(content => {
            content.classList.remove('active');
          });
          const format = this.getAttribute('data-format');
          document.getElementById(`${format}-citation`).classList.add('active');
        });
      });

      // Copy to clipboard functionality
      copyButton.addEventListener('click', function () {
        const activeTab = document.querySelector('.citation-tab-button.active');
        const activeFormat = activeTab.getAttribute('data-format');
        const contentEl = document.getElementById(`${activeFormat}-citation`);

        let textToCopy = '';
        if (activeFormat === 'bibtex') {
          textToCopy = contentEl.querySelector('pre').textContent.trim();
        } else {
          textToCopy = contentEl.querySelector('p').textContent.trim();
        }

        navigator.clipboard.writeText(textToCopy)
          .then(() => {
            copyButton.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
            setTimeout(() => {
              copyButton.innerHTML = '<i class="bi bi-clipboard"></i> Copy to clipboard';
            }, 2000);
          })
          .catch(err => {
            console.error('Failed to copy text to clipboard: ', err);
            copyButton.innerHTML = '<i class="bi bi-x-lg"></i> Failed';
            setTimeout(() => {
              copyButton.innerHTML = '<i class="bi bi-clipboard"></i> Copy to clipboard';
            }, 2000);
          });
      });

      // Close on escape key
      document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
          if (citationPopup && citationPopup.classList.contains('visible')) {
            citationPopup.classList.remove('visible');
          }
        }
      });

    });
  }

</script>


<link rel="stylesheet" href="../assets/css/main.css">
<link rel="stylesheet" href="../assets/css/citation-box.css">




<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-xl " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://research.arcadiascience.com/" class="navbar-brand navbar-brand-logo">
    <img src="../assets/logo_text.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-iconify-qlementine-iconsversion-control-16-" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text"><iconify-icon role="img" inline="" icon="qlementine-icons:version-control-16" aria-label="Icon version-control-16 from qlementine-icons Iconify.design set." title="Icon version-control-16 from qlementine-icons Iconify.design set."></iconify-icon></span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-iconify-qlementine-iconsversion-control-16-">    
        <li>
    <a class="dropdown-item" href="../index.html">
 <span class="dropdown-text">v1.1 (latest)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../index_v1.0.html">
 <span class="dropdown-text">v1.0</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="nrk:back" aria-label="Icon back from nrk Iconify.design set." title="Icon back from nrk Iconify.design set."></iconify-icon> Back to Pub</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../pages/FAQ.html"> 
<span class="menu-text">FAQ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/SETUP.html"> 
<span class="menu-text">Reproduce this pub</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../#"> 
<span class="menu-text">Cite this pub</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/CONTRIBUTING.html"> 
<span class="menu-text">Contribute</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://twitter.com/arcadiascience" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter-x"></i></a>
    <a href="https://github.com/Arcadia-Science/2025-asr-plms" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Recode deflines to 10 character max</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#build-alignment-with-mafft" id="toc-build-alignment-with-mafft" class="nav-link active" data-scroll-target="#build-alignment-with-mafft">Build alignment with MAFFT</a></li>
  <li><a href="#find-best-model-and-build-tree-with-iq-tree" id="toc-find-best-model-and-build-tree-with-iq-tree" class="nav-link" data-scroll-target="#find-best-model-and-build-tree-with-iq-tree">Find Best Model and Build Tree with IQ Tree</a></li>
  <li><a href="#root-tree-with-known-outgroup" id="toc-root-tree-with-known-outgroup" class="nav-link" data-scroll-target="#root-tree-with-known-outgroup">Root tree with known outgroup</a></li>
  <li><a href="#format-files-for-paml" id="toc-format-files-for-paml" class="nav-link" data-scroll-target="#format-files-for-paml">Format files for PAML</a></li>
  <li><a href="#reconstruct-ml-ancestors-with-paml" id="toc-reconstruct-ml-ancestors-with-paml" class="nav-link" data-scroll-target="#reconstruct-ml-ancestors-with-paml">Reconstruct ML ancestors with PAML</a></li>
  <li><a href="#parse-paml-output-files-to-get-ml-sequences-and-probabilities" id="toc-parse-paml-output-files-to-get-ml-sequences-and-probabilities" class="nav-link" data-scroll-target="#parse-paml-output-files-to-get-ml-sequences-and-probabilities">Parse PAML output files to get ML sequences and probabilities</a>
  <ul class="collapse">
  <li><a href="#generate-ancestor-trees-in-different-formats" id="toc-generate-ancestor-trees-in-different-formats" class="nav-link" data-scroll-target="#generate-ancestor-trees-in-different-formats">Generate ancestor trees in different formats</a></li>
  <li><a href="#make-files-with-ml-sequences-and-posterior-probabilities-all-nodes-with-gaps" id="toc-make-files-with-ml-sequences-and-posterior-probabilities-all-nodes-with-gaps" class="nav-link" data-scroll-target="#make-files-with-ml-sequences-and-posterior-probabilities-all-nodes-with-gaps">Make files with ML Sequences and Posterior Probabilities (all nodes with gaps)</a></li>
  </ul></li>
  <li><a href="#identify-gap-positions-based-on-parsimony-using-downpass-algorithm-from-topiary" id="toc-identify-gap-positions-based-on-parsimony-using-downpass-algorithm-from-topiary" class="nav-link" data-scroll-target="#identify-gap-positions-based-on-parsimony-using-downpass-algorithm-from-topiary">Identify gap positions based on parsimony using DOWNPASS algorithm from Topiary</a>
  <ul class="collapse">
  <li><a href="#use-gap-positions-to-write-ungapped-ml-sequences-to-output-file" id="toc-use-gap-positions-to-write-ungapped-ml-sequences-to-output-file" class="nav-link" data-scroll-target="#use-gap-positions-to-write-ungapped-ml-sequences-to-output-file">Use gap positions to write ungapped ML sequences to output file</a></li>
  <li><a href="#use-gap-positions-to-write-ungapped-probabilities-to-output-file" id="toc-use-gap-positions-to-write-ungapped-probabilities-to-output-file" class="nav-link" data-scroll-target="#use-gap-positions-to-write-ungapped-probabilities-to-output-file">Use gap positions to write ungapped probabilities to output file</a></li>
  </ul></li>
  <li><a href="#visualize-tree-with-ancestral-nodes-labeled-recommend-figtree-for-easier-viewing" id="toc-visualize-tree-with-ancestral-nodes-labeled-recommend-figtree-for-easier-viewing" class="nav-link" data-scroll-target="#visualize-tree-with-ancestral-nodes-labeled-recommend-figtree-for-easier-viewing">Visualize tree with ancestral nodes labeled (recommend FigTree for easier viewing)</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div id="cell-1" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ete3</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> Bio <span class="im">import</span> AlignIO, Phylo, SeqIO</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ete3 <span class="im">import</span> Tree</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pastml <span class="im">import</span> acr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-2" class="cell" data-tags="[&quot;parameters&quot;]">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This cell is modified by papermill for CLI execution during runtime</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>input_fasta <span class="op">=</span> <span class="st">"placeholder"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>outgroup_path <span class="op">=</span> <span class="st">"placeholder"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-3" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>input_fasta <span class="op">=</span> Path(input_fasta)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>outgroup_path <span class="op">=</span> Path(outgroup_path)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>run_folder <span class="op">=</span> Path(<span class="st">"ADA1_ASR/outputs"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>run_folder.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>, parents<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-5" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recode them to 10 char max (PAML is limited to phylip format with 10 char max)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>recoded_input_fasta <span class="op">=</span> run_folder <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>input_fasta<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">_recoded.fa"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>recoding_dict_file <span class="op">=</span> run_folder <span class="op">/</span> <span class="st">"recoding_dict.txt"</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(recoding_dict_file, <span class="st">"w"</span>) <span class="im">as</span> dict_file:</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(recoded_input_fasta, <span class="st">"w"</span>) <span class="im">as</span> seq_file:</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> record <span class="kw">in</span> SeqIO.parse(input_fasta, <span class="st">"fasta"</span>):</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            seq_name <span class="op">=</span> <span class="st">"seq"</span> <span class="op">+</span> <span class="bu">str</span>(counter)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>            seq_file.write(<span class="st">"&gt;"</span> <span class="op">+</span> seq_name <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="bu">str</span>(record.seq) <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>            dict_file.write(seq_name <span class="op">+</span> <span class="st">"</span><span class="ch">\t</span><span class="st">"</span> <span class="op">+</span> record.<span class="bu">id</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>            counter <span class="op">+=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="build-alignment-with-mafft" class="level2">
<h2 class="anchored" data-anchor-id="build-alignment-with-mafft">Build alignment with MAFFT</h2>
<div id="cell-7" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mafft_out <span class="op">=</span> recoded_input_fasta.with_stem(recoded_input_fasta.stem <span class="op">+</span> <span class="st">"_mafft"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>mafft_cmd <span class="op">=</span> <span class="ss">f"mafft --localpair </span><span class="sc">{</span>recoded_input_fasta<span class="sc">}</span><span class="ss"> &gt; </span><span class="sc">{</span>mafft_out<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> subprocess.run(mafft_cmd, shell<span class="op">=</span><span class="va">True</span>, check<span class="op">=</span><span class="va">True</span>, text<span class="op">=</span><span class="va">True</span>, capture_output<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Alignment file </span><span class="sc">{</span>mafft_out<span class="sc">}</span><span class="ss"> generated"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> subprocess.CalledProcessError <span class="im">as</span> e:</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Error occurred during execution"</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e.stderr)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to Phylip sequential format for PAML</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>mafft_phylip <span class="op">=</span> mafft_out.with_suffix(<span class="st">".ph"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>alignment <span class="op">=</span> AlignIO.read(mafft_out, <span class="st">"fasta"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>AlignIO.write(alignment, mafft_phylip, <span class="st">"phylip-sequential"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="find-best-model-and-build-tree-with-iq-tree" class="level2">
<h2 class="anchored" data-anchor-id="find-best-model-and-build-tree-with-iq-tree">Find Best Model and Build Tree with IQ Tree</h2>
<div id="cell-9" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>iqtree_cmd <span class="op">=</span> <span class="ss">f"iqtree2 -s </span><span class="sc">{</span>mafft_out<span class="sc">}</span><span class="ss"> -m TESTONLY -nt AUTO -redo"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> subprocess.run(iqtree_cmd, shell<span class="op">=</span><span class="va">True</span>, check<span class="op">=</span><span class="va">True</span>, text<span class="op">=</span><span class="va">True</span>, capture_output<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> subprocess.CalledProcessError <span class="im">as</span> e:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e.stderr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pull out best model from output files and list of models in order</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>all_models <span class="op">=</span> []</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>iqtree_output_path <span class="op">=</span> mafft_out.with_name(<span class="ss">f"</span><span class="sc">{</span>mafft_out<span class="sc">.</span>name<span class="sc">}</span><span class="ss">.iqtree"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(iqtree_output_path) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    flag <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"Best-fit model according to BIC"</span> <span class="kw">in</span> line:</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>            model_name <span class="op">=</span> line.rstrip().split(<span class="st">":"</span>)[<span class="dv">1</span>].replace(<span class="st">" "</span>, <span class="st">""</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Best model: </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>            flag <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> flag <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>            all_models.append(line.split(<span class="st">" "</span>)[<span class="dv">0</span>])</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co"># write best model to separate file to prevent overwriting in treebuilding</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>shutil.move(iqtree_output_path, mafft_out.with_name(<span class="ss">f"</span><span class="sc">{</span>mafft_out<span class="sc">.</span>name<span class="sc">}</span><span class="ss">.bestmodel"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># build tree with best model</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>iqtree_cmd <span class="op">=</span> <span class="ss">f"iqtree2 -s </span><span class="sc">{</span>mafft_out<span class="sc">}</span><span class="ss"> -m </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss"> -nt AUTO -redo"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(iqtree_cmd)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> subprocess.run(iqtree_cmd, shell<span class="op">=</span><span class="va">True</span>, check<span class="op">=</span><span class="va">True</span>, text<span class="op">=</span><span class="va">True</span>, capture_output<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Tree file </span><span class="sc">{</span>mafft_out<span class="sc">}</span><span class="ss"> generated"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> subprocess.CalledProcessError <span class="im">as</span> e:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e.stderr)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>iqtree_tree <span class="op">=</span> mafft_out.with_name(<span class="ss">f"</span><span class="sc">{</span>mafft_out<span class="sc">.</span>name<span class="sc">}</span><span class="ss">.treefile"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="root-tree-with-known-outgroup" class="level2">
<h2 class="anchored" data-anchor-id="root-tree-with-known-outgroup">Root tree with known outgroup</h2>
<div id="cell-13" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># root tree with known outgroups</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>outgroup_names <span class="op">=</span> [line.strip() <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">open</span>(outgroup_path).readlines()]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get recoded names of outgroups</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>outgroup_names_recoded <span class="op">=</span> []</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(recoding_dict_file) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        names <span class="op">=</span> line.rstrip().split(<span class="st">"</span><span class="ch">\t</span><span class="st">"</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> names[<span class="dv">1</span>] <span class="kw">in</span> outgroup_names:</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>            outgroup_names_recoded.append(names[<span class="dv">0</span>])</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>tree <span class="op">=</span> Phylo.read(iqtree_tree, <span class="st">"newick"</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>outgroup_clade <span class="op">=</span> tree.common_ancestor(outgroup_names_recoded[<span class="dv">1</span>], outgroup_names_recoded[<span class="dv">0</span>])</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>tree.root_with_outgroup(outgroup_clade)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>rooted_tree <span class="op">=</span> iqtree_tree.with_name(iqtree_tree.stem.split(<span class="st">"."</span>)[<span class="dv">0</span>] <span class="op">+</span> <span class="st">"_rooted.txt"</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>Phylo.write(tree, rooted_tree, <span class="st">"newick"</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rooted tree saved to </span><span class="sc">{</span>rooted_tree<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="format-files-for-paml" class="level2">
<h2 class="anchored" data-anchor-id="format-files-for-paml">Format files for PAML</h2>
<div id="cell-15" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get closest substitution matrix in paml to match best model from iqtree</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>model_dict <span class="op">=</span> {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cpREV"</span>: <span class="st">"cpREV64.dat"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Dayhoff"</span>: <span class="st">"dayhoff.dat"</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DCMut"</span>: <span class="st">"dayhoff-dcmut.dat"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"JTTDCMut"</span>: <span class="st">"jones-dcmut.dat"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"JTT"</span>: <span class="st">"jones.dat"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"LG"</span>: <span class="st">"lg.dat"</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mtART"</span>: <span class="st">"mtArt.dat"</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mtMAM"</span>: <span class="st">"mtmam.dat"</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mtREV"</span>: <span class="st">"mtREV24.dat"</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mtZOA"</span>: <span class="st">"MtZoa.dat"</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"WAG"</span>: <span class="st">"wag.dat"</span>,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry <span class="kw">in</span> all_models:</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> entry.split(<span class="st">"+"</span>)[<span class="dv">0</span>] <span class="kw">in</span> model_dict:</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        paml_model <span class="op">=</span> entry</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"best paml-compatible model: "</span>, paml_model)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"G4"</span> <span class="kw">in</span> entry:</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>            final_cats <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            final_cats <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"nCatG: "</span>, final_cats)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>final_model <span class="op">=</span> model_dict[paml_model.split(<span class="st">"+"</span>)[<span class="dv">0</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="reconstruct-ml-ancestors-with-paml" class="level2">
<h2 class="anchored" data-anchor-id="reconstruct-ml-ancestors-with-paml">Reconstruct ML ancestors with PAML</h2>
<div id="cell-17" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># modify config file based on sample file</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>sample_config_file <span class="op">=</span> <span class="st">"codeml_example.ctl"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>new_config_file <span class="op">=</span> run_folder <span class="op">/</span> <span class="st">"codeml.ctl"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>conda_env_path <span class="op">=</span> os.environ.get(<span class="st">"CONDA_PREFIX"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(new_config_file, <span class="st">"w"</span>) <span class="im">as</span> outfile:</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(sample_config_file) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">"seqfile"</span> <span class="kw">in</span> line:</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>                outfile.write(<span class="ss">f"seqfile = </span><span class="sc">{</span>mafft_phylip<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="st">"treefile"</span> <span class="kw">in</span> line:</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                outfile.write(<span class="ss">f"treefile = </span><span class="sc">{</span>rooted_tree<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="st">"aaRatefile"</span> <span class="kw">in</span> line:</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                outfile.write(<span class="ss">f"aaRatefile = </span><span class="sc">{</span>conda_env_path <span class="op">+</span> <span class="st">'/dat/'</span> <span class="op">+</span> final_model<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="st">"ncatG"</span> <span class="kw">in</span> line:</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                outfile.write(<span class="ss">f"ncatG = </span><span class="sc">{</span>final_cats<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                outfile.write(line)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"config file writted with aaRatefile </span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>basename(final_model)<span class="sc">}</span><span class="ss"> and nCatG = </span><span class="sc">{</span>final_cats<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run codeml</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>codeml_cmd <span class="op">=</span> <span class="ss">f"codeml </span><span class="sc">{</span>new_config_file<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># check if subsitution rate file exists (paml will get stuck otherwise)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(new_config_file) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"aaRatefile"</span> <span class="kw">in</span> line:</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>            rate_file <span class="op">=</span> line.rstrip().split(<span class="st">"aaRatefile = "</span>)[<span class="dv">1</span>]</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># run paml if rate file exists</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(rate_file):</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Error: Rate file '</span><span class="sc">{</span>rate_file<span class="sc">}</span><span class="ss">' does not exist."</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> subprocess.run(codeml_cmd, shell<span class="op">=</span><span class="va">True</span>, check<span class="op">=</span><span class="va">True</span>, text<span class="op">=</span><span class="va">True</span>, capture_output<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> subprocess.CalledProcessError <span class="im">as</span> e:</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"error: end of tree file."</span> <span class="kw">not</span> <span class="kw">in</span> e.stderr:  <span class="co"># ignore this error</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(e.stderr)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># move output files to run folder</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>outputs <span class="op">=</span> [<span class="st">"codeml_results.txt"</span>, <span class="st">"rst"</span>, <span class="st">"rst1"</span>, <span class="st">"rub"</span>, <span class="st">"rates"</span>, <span class="st">"lnf"</span>]</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry <span class="kw">in</span> outputs:</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    shutil.move(entry, run_folder <span class="op">/</span> entry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="parse-paml-output-files-to-get-ml-sequences-and-probabilities" class="level2">
<h2 class="anchored" data-anchor-id="parse-paml-output-files-to-get-ml-sequences-and-probabilities">Parse PAML output files to get ML sequences and probabilities</h2>
<section id="generate-ancestor-trees-in-different-formats" class="level3">
<h3 class="anchored" data-anchor-id="generate-ancestor-trees-in-different-formats">Generate ancestor trees in different formats</h3>
<div id="cell-21" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ancestor_cladogram <span class="op">=</span> run_folder <span class="op">/</span> <span class="st">"ancestor_cladogram.txt"</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ancestor_recoded_cladogram <span class="op">=</span> run_folder <span class="op">/</span> <span class="st">"ancestor_recoded_cladogram.txt"</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>ancestor_tree <span class="op">=</span> run_folder <span class="op">/</span> <span class="st">"ancestor_tree.txt"</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>ancestor_recoded_tree <span class="op">=</span> run_folder <span class="op">/</span> <span class="st">"ancestor_recoded_tree.txt"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># pull out ancestor tree string from rst file</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>tree_string <span class="op">=</span> <span class="st">""</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>flag <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(run_folder <span class="op">/</span> <span class="st">"rst"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"tree with node labels for Rod Page's TreeView"</span> <span class="kw">in</span> line:</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>            flag <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">"are ancestral"</span> <span class="kw">in</span> line:</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>            flag <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> flag <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>            tree_string <span class="op">=</span> tree_string <span class="op">+</span> line</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># remove codeml numbers from sequence names</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(ancestor_recoded_cladogram, <span class="st">"w"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span>.write(tree_string)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>terminals <span class="op">=</span> [x.name <span class="cf">for</span> x <span class="kw">in</span> Phylo.read(ancestor_recoded_cladogram, <span class="st">"newick"</span>).get_terminals()]</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry <span class="kw">in</span> terminals:</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    tree_string <span class="op">=</span> tree_string.replace(entry <span class="op">+</span> <span class="st">","</span>, entry.split(<span class="st">"_"</span>)[<span class="dv">1</span>] <span class="op">+</span> <span class="st">","</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    tree_string <span class="op">=</span> tree_string.replace(entry <span class="op">+</span> <span class="st">")"</span>, entry.split(<span class="st">"_"</span>)[<span class="dv">1</span>] <span class="op">+</span> <span class="st">")"</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="co"># remove codeml numbers from sequence names</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(ancestor_recoded_cladogram, <span class="st">"w"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span>.write(tree_string)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co"># recode ancestor cladogram to original names</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>name_dict <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">zip</span>(</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>        [line.rstrip().split(<span class="st">"</span><span class="ch">\t</span><span class="st">"</span>)[<span class="dv">0</span>] <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">open</span>(recoding_dict_file)],</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>        [line.rstrip().split(<span class="st">"</span><span class="ch">\t</span><span class="st">"</span>)[<span class="dv">1</span>] <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">open</span>(recoding_dict_file)],</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        strict<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry <span class="kw">in</span> name_dict:</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    tree_string <span class="op">=</span> tree_string.replace(entry <span class="op">+</span> <span class="st">","</span>, name_dict[entry] <span class="op">+</span> <span class="st">","</span>)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    tree_string <span class="op">=</span> tree_string.replace(entry <span class="op">+</span> <span class="st">")"</span>, name_dict[entry] <span class="op">+</span> <span class="st">")"</span>)</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a><span class="co"># write to cladogram file</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(ancestor_cladogram, <span class="st">"w"</span>) <span class="im">as</span> outfile:</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    outfile.write(tree_string)</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Transfer node labels to tree with branch lengths</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>cladogram_tree <span class="op">=</span> Tree(<span class="bu">str</span>(ancestor_cladogram), <span class="bu">format</span><span class="op">=</span><span class="dv">1</span>)  <span class="co"># Format 1 preserves internal node names</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>branch_length_tree <span class="op">=</span> Tree(<span class="bu">str</span>(rooted_tree), <span class="bu">format</span><span class="op">=</span><span class="dv">1</span>)  <span class="co"># No node names, but correct topology</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract internal node labels from cladogram</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>cladogram_nodes <span class="op">=</span> cladogram_tree.get_descendants(<span class="st">"postorder"</span>)</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>branch_nodes <span class="op">=</span> branch_length_tree.get_descendants(<span class="st">"postorder"</span>)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mapping of cladogram node labels to their topological positions</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>node_label_map <span class="op">=</span> {}</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> node <span class="kw">in</span> cladogram_nodes:</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> node.name:  <span class="co"># Internal node labels</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>        node_label_map[<span class="bu">id</span>(node)] <span class="op">=</span> node.name</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign labels to the branch-length tree, assuming same topology</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> clad_node, branch_node <span class="kw">in</span> <span class="bu">zip</span>(cladogram_nodes, branch_nodes, strict<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">id</span>(clad_node) <span class="kw">in</span> node_label_map:</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>        branch_node.name <span class="op">=</span> node_label_map[<span class="bu">id</span>(clad_node)]</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the updated tree with labels</span></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>branch_length_tree.write(outfile<span class="op">=</span>ancestor_tree, <span class="bu">format</span><span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a><span class="co"># REPEAT FOR RECODED TREE</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Add node labels to original trees (orig and recoded both)</span></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>cladogram_tree <span class="op">=</span> Tree(<span class="bu">str</span>(ancestor_recoded_cladogram), <span class="bu">format</span><span class="op">=</span><span class="dv">1</span>)  <span class="co"># Format 1 preserves node names</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>branch_length_tree <span class="op">=</span> Tree(<span class="bu">str</span>(rooted_tree), <span class="bu">format</span><span class="op">=</span><span class="dv">1</span>)  <span class="co"># No node names, but correct topology</span></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract internal node labels from cladogram</span></span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>cladogram_nodes <span class="op">=</span> cladogram_tree.get_descendants(<span class="st">"postorder"</span>)</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>branch_nodes <span class="op">=</span> branch_length_tree.get_descendants(<span class="st">"postorder"</span>)</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mapping of cladogram node labels to their topological positions</span></span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>node_label_map <span class="op">=</span> {}</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> node <span class="kw">in</span> cladogram_nodes:</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> node.name:  <span class="co"># Internal node labels</span></span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>        node_label_map[<span class="bu">id</span>(node)] <span class="op">=</span> node.name</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign labels to the branch-length tree, assuming same topology</span></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> clad_node, branch_node <span class="kw">in</span> <span class="bu">zip</span>(cladogram_nodes, branch_nodes, strict<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">id</span>(clad_node) <span class="kw">in</span> node_label_map:</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>        branch_node.name <span class="op">=</span> node_label_map[<span class="bu">id</span>(clad_node)]</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the updated tree with labels</span></span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>branch_length_tree.write(outfile<span class="op">=</span>ancestor_recoded_tree, <span class="bu">format</span><span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-files-with-ml-sequences-and-posterior-probabilities-all-nodes-with-gaps" class="level3">
<h3 class="anchored" data-anchor-id="make-files-with-ml-sequences-and-posterior-probabilities-all-nodes-with-gaps">Make files with ML Sequences and Posterior Probabilities (all nodes with gaps)</h3>
<div id="cell-23" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>codeml_results <span class="op">=</span> run_folder <span class="op">/</span> <span class="st">"rst"</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>flag <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>seqs_dict <span class="op">=</span> {}</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>probs_dict <span class="op">=</span> {}</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>res_list <span class="op">=</span> [</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"D"</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"E"</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"F"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"G"</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"H"</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"I"</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"K"</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"L"</span>,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"M"</span>,</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"N"</span>,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"P"</span>,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Q"</span>,</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"R"</span>,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"S"</span>,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"T"</span>,</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"V"</span>,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"W"</span>,</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Y"</span>,</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(codeml_results) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"Prob distribution at node"</span> <span class="kw">in</span> line <span class="kw">and</span> <span class="st">" by site"</span> <span class="kw">in</span> line:</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>            node <span class="op">=</span> <span class="st">"node"</span> <span class="op">+</span> line.split(<span class="st">"node "</span>)[<span class="dv">1</span>].split(<span class="st">","</span>)[<span class="dv">0</span>]</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>            seqs_dict[node] <span class="op">=</span> <span class="st">""</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>            probs_dict[node] <span class="op">=</span> []</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>            flag <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> flag <span class="op">==</span> <span class="dv">1</span> <span class="kw">and</span> <span class="st">":"</span> <span class="kw">in</span> line:</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>            all_probs <span class="op">=</span> line.rstrip().split(<span class="st">":"</span>)[<span class="dv">1</span>].split(<span class="st">" "</span>)[<span class="dv">1</span>:]</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>            letters <span class="op">=</span> [x.split(<span class="st">"("</span>)[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> all_probs]</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>            probs <span class="op">=</span> [<span class="bu">float</span>(x.split(<span class="st">"("</span>)[<span class="dv">1</span>].split(<span class="st">")"</span>)[<span class="dv">0</span>]) <span class="cf">for</span> x <span class="kw">in</span> all_probs]</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>            support_dict <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(letters, probs, strict<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>            max_res <span class="op">=</span> <span class="bu">max</span>(support_dict, key<span class="op">=</span>support_dict.get)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>            seqs_dict[node] <span class="op">=</span> seqs_dict[node] <span class="op">+</span> max_res</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>            probs_ordered <span class="op">=</span> [support_dict[x] <span class="cf">for</span> x <span class="kw">in</span> res_list]</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>            probs_dict[node].append(probs_ordered)</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">"Prob of best state at each node, listed by site"</span> <span class="kw">in</span> line:</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>ml_seqs_with_gaps <span class="op">=</span> run_folder <span class="op">/</span> <span class="st">"ML_ancestors_with_gaps.fa"</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(ml_seqs_with_gaps, <span class="st">"w"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entry <span class="kw">in</span> seqs_dict:</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">file</span>.write(<span class="st">"&gt;"</span> <span class="op">+</span> entry <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> seqs_dict[entry] <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>post_probs_file <span class="op">=</span> run_folder <span class="op">/</span> <span class="st">"posterior_probabilities.json"</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(post_probs_file, <span class="st">"w"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    json.dump(probs_dict, <span class="bu">file</span>, indent<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="identify-gap-positions-based-on-parsimony-using-downpass-algorithm-from-topiary" class="level2">
<h2 class="anchored" data-anchor-id="identify-gap-positions-based-on-parsimony-using-downpass-algorithm-from-topiary">Identify gap positions based on parsimony using DOWNPASS algorithm from Topiary</h2>
<div id="cell-25" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_alignment(file_path):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Read the PHYLIP alignment file and return a gap matrix.</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    alignment <span class="op">=</span> AlignIO.read(file_path, <span class="st">"phylip"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize a list to store gap info</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    taxa_names <span class="op">=</span> [record.<span class="bu">id</span> <span class="cf">for</span> record <span class="kw">in</span> alignment]</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    num_sites <span class="op">=</span> alignment.get_alignment_length()</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a matrix for gaps (True = gap, False = no gap)</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    gap_matrix <span class="op">=</span> np.zeros((<span class="bu">len</span>(taxa_names), num_sites), dtype<span class="op">=</span>np.uint8)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, record <span class="kw">in</span> <span class="bu">enumerate</span>(alignment):</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j, char <span class="kw">in</span> <span class="bu">enumerate</span>(record.seq):</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>            gap_matrix[i, j] <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> char <span class="op">==</span> <span class="st">"-"</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the gap matrix into a pandas DataFrame</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    gap_df <span class="op">=</span> pd.DataFrame(gap_matrix, columns<span class="op">=</span>[<span class="ss">f"g</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_sites)], index<span class="op">=</span>taxa_names)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gap_df, taxa_names</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_tree(tree_file):</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse the tree and return the tree object.</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    tree <span class="op">=</span> ete3.Tree(tree_file, <span class="bu">format</span><span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tree</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> infer_ancestral_gaps(alignment_file, tree_file, prediction_method<span class="op">=</span><span class="st">"DOWNPASS"</span>):</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="co">    Infer gaps at ancestral nodes using the acr function from pastml.</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Read the PHYLIP alignment file</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    gap_df, leaf_names <span class="op">=</span> read_alignment(alignment_file)</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Parse the tree file</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    tree <span class="op">=</span> parse_tree(<span class="bu">str</span>(tree_file))</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Run the gap reconstruction using the DOWNPASS algorithm</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    acr.acr(tree, gap_df, prediction_method<span class="op">=</span>prediction_method)</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 5: Create a dictionary for gaps in ancestral nodes</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>    gap_anc_dict <span class="op">=</span> {}</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> node <span class="kw">in</span> tree.traverse(<span class="st">"preorder"</span>):</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node.name <span class="kw">in</span> leaf_names:</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span>  <span class="co"># Skip leaf nodes</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>        gap_anc_dict[node.name] <span class="op">=</span> []</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Collect gap information for each ancestral node</span></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> gap_df.columns:</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>            state <span class="op">=</span> node.__dict__.get(col, <span class="va">None</span>)</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(state, <span class="bu">set</span>):</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(state) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>                    state <span class="op">=</span> <span class="va">True</span> <span class="cf">if</span> <span class="dv">1</span> <span class="kw">in</span> state <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>                    state <span class="op">=</span> <span class="va">None</span></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>            gap_anc_dict[node.name].append(state)</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gap_anc_dict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>alignment_file <span class="op">=</span> mafft_phylip</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>tree_file <span class="op">=</span> ancestor_recoded_tree</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>gap_anc_dict <span class="op">=</span> infer_ancestral_gaps(alignment_file, tree_file, prediction_method<span class="op">=</span><span class="st">"DOWNPASS"</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># write gaps to json</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>gaps_file <span class="op">=</span> run_folder <span class="op">/</span> <span class="st">"gap_positions.json"</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(gaps_file, <span class="st">"w"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    json.dump(gap_anc_dict, <span class="bu">file</span>, indent<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="use-gap-positions-to-write-ungapped-ml-sequences-to-output-file" class="level3">
<h3 class="anchored" data-anchor-id="use-gap-positions-to-write-ungapped-ml-sequences-to-output-file">Use gap positions to write ungapped ML sequences to output file</h3>
<div id="cell-28" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ml_seqs_no_gaps <span class="op">=</span> run_folder <span class="op">/</span> <span class="st">"ML_ancestors.fa"</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(ml_seqs_no_gaps, <span class="st">"w"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> record <span class="kw">in</span> SeqIO.parse(ml_seqs_with_gaps, <span class="st">"fasta"</span>):</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        node_num <span class="op">=</span> record.<span class="bu">id</span>.split(<span class="st">"node"</span>)[<span class="dv">1</span>]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node_num <span class="kw">not</span> <span class="kw">in</span> gap_anc_dict:</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>            <span class="co"># no gaps inferred for deepest node (shouldnt reconstruct this anyway)</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"no gaps inferred for node "</span>, node_num, <span class="st">"(root node)"</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>            full_seq <span class="op">=</span> <span class="bu">list</span>(<span class="bu">str</span>(record.seq))</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>            trimmed_seq <span class="op">=</span> (<span class="st">""</span>).join(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>                [x <span class="cf">for</span> i, x <span class="kw">in</span> <span class="bu">enumerate</span>(full_seq) <span class="cf">if</span> <span class="kw">not</span> gap_anc_dict[node_num][i]]</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>            <span class="bu">file</span>.write(<span class="ss">f"&gt;node</span><span class="sc">{</span>node_num<span class="sc">}</span><span class="ch">\n</span><span class="sc">{</span>trimmed_seq<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-gap-positions-to-write-ungapped-probabilities-to-output-file" class="level3">
<h3 class="anchored" data-anchor-id="use-gap-positions-to-write-ungapped-probabilities-to-output-file">Use gap positions to write ungapped probabilities to output file</h3>
<div id="cell-30" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>post_probs_no_gaps <span class="op">=</span> run_folder <span class="op">/</span> <span class="st">"posterior_probabilities_no_gaps.json"</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(post_probs_file) <span class="im">as</span> f:</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    probs_dict <span class="op">=</span> json.load(f)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># mask positions with gaps</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>probs_dict_no_gaps <span class="op">=</span> {}</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry <span class="kw">in</span> probs_dict:</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    node_num <span class="op">=</span> entry.split(<span class="st">"node"</span>)[<span class="dv">1</span>]</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> node_num <span class="kw">not</span> <span class="kw">in</span> gap_anc_dict:</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"no gaps inferred for node "</span>, node_num, <span class="st">" (root node)"</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        full_matrix_probs <span class="op">=</span> probs_dict[entry]</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        matrix_masked <span class="op">=</span> [</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>            x <span class="cf">for</span> i, x <span class="kw">in</span> <span class="bu">enumerate</span>(full_matrix_probs) <span class="cf">if</span> <span class="kw">not</span> gap_anc_dict[node_num][i]</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        probs_dict_no_gaps[entry] <span class="op">=</span> matrix_masked</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(post_probs_no_gaps, <span class="st">"w"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    json.dump(probs_dict_no_gaps, <span class="bu">file</span>, indent<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="visualize-tree-with-ancestral-nodes-labeled-recommend-figtree-for-easier-viewing" class="level2">
<h2 class="anchored" data-anchor-id="visualize-tree-with-ancestral-nodes-labeled-recommend-figtree-for-easier-viewing">Visualize tree with ancestral nodes labeled (recommend FigTree for easier viewing)</h2>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>tree <span class="op">=</span> Phylo.read(ancestor_tree, <span class="st">"newick"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">60</span>))  <span class="co"># Adjust size (width, height)</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Customize and render the tree</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>Phylo.draw(</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    tree,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    axes<span class="op">=</span>ax,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    label_colors<span class="op">=</span>{<span class="st">"orange"</span>: <span class="st">"orange"</span>},  <span class="co"># Specify colors for labels</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    do_show<span class="op">=</span><span class="va">False</span>,  <span class="co"># Prevent automatic display</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Manually highlight nodes by drawing them in orange</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> clade <span class="kw">in</span> tree.find_clades():</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(clade, <span class="st">"color"</span>) <span class="kw">and</span> clade.color <span class="op">==</span> <span class="st">"orange"</span>:</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        ax.text(</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>            clade.branch_length,  <span class="co"># X-coordinate</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>            tree.depths()[clade],  <span class="co"># Y-coordinate</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>            clade.name,  <span class="co"># Node label</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">"orange"</span>,</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>            fontsize<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/Arcadia-Science\.github\.io\/2025-asr-plms\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "Arcadia-Science/2025-asr-plms";
    script.dataset.repoId = "R_kgDOOncD9w";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOOncD984Ctjdm";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://www.arcadiascience.com/"><img src="../assets/logo_white.png" class="img-fluid" alt="Arcadia-Science" width="65"></a> Copyright 2025, Arcadia Science</p>
</div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/arcadiascience">
      <i class="bi bi-twitter-x" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Arcadia-Science">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>